name: Auto Phase Promotion (Auto-PR)

# ADR-003: フェーズ完了（PRマージ）をトリガーとして、次フェーズのタスクを自動展開します。
# PR 本文の "Closes #XXX" から完了したタスクを特定し、連鎖を開始します。

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - feature/task-T3-5-verify

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-promotion:
    # main へのマージ時のみ実行
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 全ての履歴を取得（ブランチ作成に必要）

      - name: Install Issue Creator Kit
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install git+https://github.com/masa-codehub/issue_creator_kit.git

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Process Merge and Promote Phase
        run: |
          # マージされた PR の本文から連鎖対象を特定し、Auto-PR を作成します。
          # PR本文には改行や特殊文字が含まれる可能性があるため、環境変数経由で安全に渡します。
          export PR_BODY="${{ github.event.pull_request.body }}"
          
          python3 -m issue_creator_kit process-merge \
            --pr-body "$PR_BODY" \
            --repo ${{ github.repository }} \
            --token ${{ secrets.GITHUB_TOKEN }}

