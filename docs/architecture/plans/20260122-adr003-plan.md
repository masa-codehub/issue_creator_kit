# Architecture Visualization Plan: ADR-003 Task Lifecycle

- **Status**: Draft
- **Author**: SYSTEM_ARCHITECT
- **Source ADR**: [ADR-003: 仮想キューと自己推進型ワークフロー](../../reqs/design/_approved/adr-003-task-and-roadmap-lifecycle.md)

## 1. コンテキストと目的 (Context & Objective)
- **Objective:** ADR-003 で定義された「仮想キュー」「フェーズ連鎖」「自己推進型ワークフロー」のアーキテクチャを可視化し、実装者（Spec Strategist / Backend Coder）が迷わず設計・実装できる状態にする。
- **Key Decision:**
    - 物理キュー (`_queue/`) を廃止し、`git diff` ベースの仮想キューを採用。
    - 「起票」と「完了」の責務を分離し、PRベースの自動連鎖メカニズムを導入。
    - インフラ層（Git/GitHub操作）とドメイン層（タスク状態管理）の厳格な分離。

## 2. 参照したSSOT一覧 (SSOT Audit Log)
- [x] `reqs/design/_approved/adr-003-task-and-roadmap-lifecycle.md` (Source)
- [x] `docs/system-context.md` (Overall Boundary)
- [x] `docs/specs/logic/approval_usecase.md` (Legacy Logic Reference)
- [x] `src/issue_creator_kit/` (Current Implementation Gap Analysis)

## 3. 共通定義とマッピング (Common Definitions & Mapping)

### 3.1. ユビキタス言語 (Ubiquitous Language)
| 用語 (Term) | 定義 (Definition) | コード上の表現 (Class/Variable) |
| :--- | :--- | :--- |
| **Virtual Queue** | `archive/` ディレクトリにコミット（マージ）されたが、まだ Issue 番号が付与されていないファイルの集合。 | `GitAdapter.get_added_files(path="reqs/tasks/archive")` |
| **Phase Chain (Auto-PR)** | フェーズ最終タスクの完了をトリガーに、次フェーズの Draft ファイルを Archive へ移動させる PR を自動作成する仕組み。 | `WorkflowUseCase.promote_next_phase()` |
| **Atomic Creation** | 一連の Issue 起票処理において、Git コミットを最小単位とし、中途半端な状態を残さない（Fail-fast）原則。 | `Transaction` (Concept), `No partial commits` |
| **Roadmap Sync** | タスクの起票・完了に合わせて、ロードマップ（Markdown）内のリンクとステータスを自動更新する機能。 | `RoadmapSyncUseCase` |

### 3.2. レイヤーとコンポーネント (Layers & Components)
| レイヤー名 | 責務 (Responsibility) | 具体的なディレクトリ/ファイル (Physical Path) | 禁止事項 (Anti-Pattern) |
| :--- | :--- | :--- | :--- |
| **Workflow (App)** | 全体の流れ（Orchestration）を制御。CLI からの指示を受け、UseCases を順序通り実行する。 | `src/issue_creator_kit/cli.py` | 具体的なビジネスロジックの実装 |
| **UseCase (Domain)** | 「起票」「同期」「連鎖」の各ビジネスロジック。Adapter を使用して外界と対話するが、依存はしない（DIP）。 | `src/issue_creator_kit/usecase/` (`creation.py`, `workflow.py`, `roadmap_sync.py`) | Gitコマンドの直接実行、APIトークンの直接参照 |
| **Infrastructure** | 外部システム（Git, GitHub, FileSystem）へのアクセス詳細を隠蔽する。 | `src/issue_creator_kit/infrastructure/` (`git_adapter.py`, `github_adapter.py`) | ドメインルールの実装（例：タスク状態の判定） |

## 4. 作図戦略 (Diagram Strategy)

| 図の種類 (Type) | ファイル名 (File Name) | 描く範囲 (Scope/Boundary) | 目的・伝えたいこと (Intent) |
| :--- | :--- | :--- | :--- |
| **C4 Container (Structure)** | `arch-structure-003-vqueue.md` | `issue_creator_kit` 内部のコンポーネント構造 | 新しい UseCase (`Creation`, `RoadmapSync`) と Adapter の依存関係を明確にする。 |
| **Sequence Diagram (Behavior)** | `arch-behavior-003-creation.md` | PRマージ -> 仮想キュー検知 -> 一括起票 -> ロードマップ更新 | 原子性（Atomic Creation）とエラー時の停止位置（Fail-fast）を時系列で示す。 |
| **Sequence Diagram (Behavior)** | `arch-behavior-003-autopr.md` | 最終タスク完了 -> Auto-PR 作成 | フェーズ連鎖のトリガー条件と、ブランチ操作の流れを示す。 |
| **State Diagram (State)** | `arch-state-003-task-lifecycle.md` | タスク（Document）の状態遷移 | Draft -> Queued (Virtual) -> Active (Issue) -> Archived への遷移とトリガーイベントを定義する。 |

## 5. 技術選定 (Technical Decisions)
- **Diagram Tool:** Mermaid.js
- **Style:** C4 Model (Container), UML Sequence/State Diagram
