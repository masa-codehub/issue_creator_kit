# Roadmap Sync Logic Specification

## 1. 概要 (Overview)
`RoadmapSyncUseCase` は、タスクが起票（Active化）された際に、ロードマップ（Markdown）内の WBS テーブルを自動更新する。
更新内容には、タスクファイルへの相対パスの置換（`drafts/` -> `archive/`）と、確定した GitHub Issue 番号の追記が含まれる。

## 2. 入力 (Input)
| Name | Type | Description |
| :--- | :--- | :--- |
| `roadmap_path` | `Path` | 更新対象のロードマップファイル（`.md`）のパス。 |
| `results` | `List[tuple[Path, int]]` | 起票結果のリスト。`(物理ファイルパス, Issue番号)` のタプル群。 |

## 3. ロジック詳細 (Logic Details)

### 3.1. 検索キーの導出
`results` に含まれる `Path`（起票済みのアーカイブパス）から、ロードマップ内の検索に使用するキーワードを特定する。
1. **ファイル名**: `path.name` (例: `task-T1.md`)。
2. **期待される Draft パス**: アーカイブパス内の `archive` セグメントを `drafts` に置換した文字列。

### 3.2. 置換アルゴリズム (Algorithm)
対象言語 / エンジン: Python の `re` モジュール（`re.sub`）を想定。
`results` の各ペアに対して、以下のステップを実行する。

1. **リンク対象行の特定**:
   - 行内の Markdown リンクの「リンクテキスト」が、ファイル名と完全一致するものを対象とする。
   - （例: `[task-T1.md](../../tasks/drafts/phase-1/task-T1.md)` は対象、`[タイトル](.../task-T1.md)` は現仕様では対象外）

2. **動的正規表現による置換 (Path Update)**:
   - 各ファイルに対して個別のパターンを生成し、誤置換を防止する。
   - パターン例: `rf"\[({re.escape(filename)})\]\(([^)]*?)drafts/([^)]*?{re.escape(filename)})\)"`
   - 置換後: `[\1](\2archive/\3)`
   - 目的: リンクテキストを維持しつつ、対象ファイルへのパス内の `drafts/` を `archive/` に変更する。

3. **Issue 番号の追記 (Issue Mapping)**:
   - リンクの直後に Issue 番号を追記する。
   - 期待値フォーマット: `[filename.md](../../tasks/archive/file.md) (#123)`
   - 追記位置: Markdown リンク `[...](...)` の直後。

### 3.3. 冪等性と整合性の担保 (Idempotency & Integrity)
二重更新や不整合を防止するため、以下のガード条件を適用する。

- **ガード条件**:
  - パスが既に `archive/` を含んでいる場合は、パス置換をスキップする。
  - リンクの直後に既に同一の `(#123)` が存在している場合は、追記をスキップする。
  - **番号不一致時の扱い**: 既に別の番号（例: `(#999)`）が付与されている場合は、警告を出力して置換をスキップし、人間による確認を促す。

## 4. エッジケース (Edge Cases)
| ケース | 期待される挙動 |
| :--- | :--- |
| 同一ファイル名のタスクが複数ある | 警告を出力して最初の 1 件のみ処理するか、相対パスの部分一致により厳密に判定する。 |
| ロードマップ内にテーブルが複数ある | 全てのテーブル（ファイル全体）を対象とするが、リンクが含まれない行は変更しない。 |
| リンク先が `.md` 以外 | 置換対象外とする。 |
| 指定された `roadmap_path` が存在しない | `FileNotFoundError` を送出し、CLI はエラー終了（非ゼロ終了コード）とする。 |

## 5. 検証基準 (Verification)

### 5.1. 正常系テストケース
- **Input**:
  - `roadmap_content`: `| T1-1 | ... | [T1-1.md](../../tasks/drafts/phase-1/T1-1.md) |`
  - `results`: `[(Path("reqs/tasks/archive/phase-1/T1-1.md"), 123)]`
- **Expected Output**:
  - `| T1-1 | ... | [T1-1.md](../../tasks/archive/phase-1/T1-1.md) (#123) |`

### 5.2. 異常系・境界値テストケース
- 既に置換済みの行に対して再度実行しても、内容が変化しないこと。
- ロードマップのヘッダー行や説明文に含まれる同一ファイル名へのテキスト（リンク以外）は置換されないこと。
