# Roadmap Sync Logic Specification

## 1. 概要 (Overview)
`RoadmapSyncUseCase` は、タスクが起票（Active化）された際に、ロードマップ（Markdown）内の WBS テーブルを自動更新する。
更新内容には、タスクファイルへの相対パスの置換（`drafts/` -> `archive/`）と、確定した GitHub Issue 番号の追記が含まれる。

## 2. 入力 (Input)
| Name | Type | Description |
| :--- | :--- | :--- |
| `roadmap_path` | `Path` | 更新対象のロードマップファイル（`.md`）のパス。 |
| `results` | `List[tuple[Path, int]]` | 起票結果のリスト。`(物理ファイルパス, Issue番号)` のタプル群。 |

## 3. ロジック詳細 (Logic Details)

### 3.1. 置換対象の行特定
ロードマップファイルを行単位でスキャンし、`results` に含まれる物理ファイルパスを指す Markdown リンクを含む行を特定する。

### 3.2. 置換アルゴリズム (Algorithm)
各行に対し、以下のステップで置換を実行する。

1. **パスの正規化**:
   - `results` の `Path` オブジェクトからファイル名（例: `task-T1.md`）を抽出する。
   - Markdown 内のリンク先パスがそのファイル名で終わっているかを確認する。

2. **正規表現による置換 (Path Update)**:
   - パターン: `\[(.*?)\]\((.*?/|)drafts/(.*?/|)([^)]+?\.md)\)`
   - 置換後: `[$1]($2archive/$3$4)`
   - 目的: リンクテキストを維持しつつ、パス内の `drafts/` を `archive/` に変更する。

3. **Issue 番号の追記 (Issue Mapping)**:
   - リンクの直後に Issue 番号を追記する。
   - 期待値フォーマット: `[Title](../../tasks/archive/file.md) (#123)`
   - 追記位置: Markdown リンク `[...](...)` の直後。

### 3.3. 冪等性の担保 (Idempotency)
既に `archive/` への置換が行われている、または既に Issue 番号が追記されている場合に、二重に更新しないようにガードする。

- **ガード条件**:
  - リンクが既に `archive/` を含んでいる場合は、パス置換をスキップする。
  - リンクの直後に既に同一の `(#123)` が存在している場合は、追記をスキップする。

## 4. エッジケース (Edge Cases)
| ケース | 期待される挙動 |
| :--- | :--- |
| 同一ファイル名のタスクが複数ある | ファイル名だけでなく、ディレクトリ構造も含めた相対パスの部分一致で判定の精度を高める。 |
| ロードマップ内にテーブルが複数ある | 全てのテーブル（ファイル全体）を対象とするが、リンクが含まれない行は変更しない。 |
| リンク先が `.md` 以外 | 置換対象外とする。 |
| 指定された `roadmap_path` が存在しない | 警告を出力し、処理を終了する（起票自体は成功扱い）。 |

## 5. 検証基準 (Verification)

### 5.1. 正常系テストケース
- **Input**:
  - `roadmap_content`: `| T1-1 | ... | [タスク内容](../../tasks/drafts/phase-1/T1-1.md) |`
  - `results`: `[(Path("reqs/tasks/archive/phase-1/T1-1.md"), 123)]`
- **Expected Output**:
  - `| T1-1 | ... | [タスク内容](../../tasks/archive/phase-1/T1-1.md) (#123) |`

### 5.2. 異常系・境界値テストケース
- 既に置換済みの行に対して再度実行しても、内容が変化しないこと。
- ロードマップのヘッダー行や説明文に含まれる同一ファイル名へのテキスト（リンク以外）は置換されないこと。
