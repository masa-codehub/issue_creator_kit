# 振り返りレポート (YWT) - PR #327 Review Analysis

## 1. Y (やったこと)

- **作業の実施内容:**
  - PR #327 に対するレビュー指摘の分析。
  - `docs/specs/logic/scanner-logic.md` の内容と ADR-008 (adr-008-automation-cleanup.md) および `definitions.md` の整合性確認。
  - `docs/specs/logic/` 配下の既存ファイルの命名規則の調査。
- **事象の観測:**
  - `scanner-logic.md` 内で `root_path` を含むパス表記（`reqs/`）が重複しており、実装上の誤解を招く状態だった。
  - `exclude_patterns` の定義があるが、アルゴリズム内で活用手順が記述されていなかった。
  - ID重複検知において、アーカイブとの衝突を「無視」する方針となっており、安全性の目標（ADR-008）と矛盾していた。
  - 命名規則が `definitions.md`（ハイフン）と実際のディレクトリ内（アンダーバー）で不一致だった。
- **分析情報の集約:**
  - `reqs/design/_approved/adr-008-automation-cleanup.md`
  - `docs/specs/plans/adr-008-automation-cleanup/definitions.md`
  - `docs/specs/logic/` 配下のディレクトリリスト

## 2. W (わかったこと)

- **結果の確認:**
  - 詳細設計レベルでのパス表記の曖昧さが、実装時のバグ（パス二重結合）の直接原因になり得ること。
  - IDの一意性管理は「未処理」の判定ロジックよりも優先度が高く、アーカイブも含めたグローバルな Fail-fast ガードレールが必要であること。

### ギャップ分析

- **理想 (To-Be):**
  - 仕様書は「実行可能な設計図」であり、パス表記、除外ロジック、エラーコードが実装と 1:1 で対応している状態。
  - ADR-008 の「安全性」に基づき、ID重複はあらゆるケースで即座に検知・停止される状態。
- **現状 (As-Is):**
  - パス表記が `root_path` と重複。除外ロジックが未記述。ID重複判定が「アーカイブ優先の無視」という甘い設計。
- **ギャップ:**
  - ADRの方針（引き算のリファクタリング、安全性）が、詳細仕様（ロジック）に完全には落とし込めていなかった。
- **要因 (Root Cause):**
  - `ScannerLogic` を「単体」の機能として捉え、システム全体の「ID一意性」という不変条件（Domain Guardrails）との連携が考慮漏れしていたため。

## 3. T (次やること / 仮説立案)

- **実証的仮説:**
  - 仕様書のパス表記を相対パスに統一し、アルゴリズムに `exclude_patterns` の適用ステップを追加すれば、実装の曖昧さが排除される。
- **飛躍的仮説:**
  - `DUPLICATE_ID` 判定を、スキャナー内だけでなく `Domain Model` の初期化時に全件バリデーションとして組み込めば、スキャナーの実装に依存せず安全性を担保できる。
- **逆説的仮説:**
  - ファイル名の命名規則は、計画（definitions.md）よりも「配置先の既存ルール（docs/specs/logic/）」を優先すべきであり、`definitions.md` 側の記述を是正すべきではないか。

### 検証アクション

- [x] `scanner_logic.md` への修正案作成（パス、除外、Fail-fast）。
- [x] `definitions.md` への `DUPLICATE_ID` 追加。
- [x] 既存ファイルとの一貫性を重視し、`scanner-logic.md` を `scanner_logic.md` にリネーム。
