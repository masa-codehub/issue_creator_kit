# Specification Planning: ADR-003 Implementation

- **Status**: Draft
- **Author**: SYSTEM_ARCHITECT
- **Source Architecture**: [Architecture Plan](../../architecture/plans/20260122-adr003-plan.md)

## 1. コンテキストと目的 (Context & Objective)
- **Objective:** ADR-003 で定義された「仮想キュー」「フェーズ連鎖」のアーキテクチャ図を、開発者が TDD で実装可能なレベルの「詳細仕様書（Specs）」に変換する。
- **Key Requirement:**
    - `1 PR = 1 Task Transition` の原則に基づいたシンプルな自動化ロジックの定義。
    - 原子的な起票処理と Fail-fast 挙動の厳密な定義。
    - メタデータ正規化と日本語キーマッピングをドメインモデル仕様に統合。

## 2. 参照した資料一覧 (Input Log)
- [x] `reqs/design/_approved/adr-003-task-and-roadmap-lifecycle.md`
- [x] `docs/architecture/arch-structure-003-vqueue.md`
- [x] `docs/architecture/arch-behavior-003-creation.md`
- [x] `docs/architecture/arch-behavior-003-autopr.md`
- [x] `docs/architecture/arch-state-003-task-lifecycle.md`
- [x] `docs/handovers/arch-to-spec.md`

## 3. 共通定義 (Common Definitions)

### 3.1. ユビキタス言語 (Ubiquitous Language)
| 用語 (Term) | 仕様上の定義 | 実装予定の物理パス |
| :--- | :--- | :--- |
| **Task Metadata** | YAML Frontmatter に含まれる制御フィールド群。 | `Document.metadata` |
| **Virtual Queue** | `archive/` 下で `issue` 番号が未設定のファイル群。 | `creation_uc.detect_queue()` |
| **Phase Promotion** | フェーズ完了時に次フェーズのタスクを Archive へ移動すること。 | `workflow_uc.promote_next_phase()` |
| **Foundation Branch** | フェーズ開始時に `main` から作成される基点ブランチ。 | `feature/{phase}-foundation` |

### 3.2. 共通メタデータスキーマ (Shared Schema)
- `title` (str): Issue タイトル。
- `issue` (int/str): GitHub Issue 番号（例: `123` または `#123`）。
- `status` (str): `Draft`, `Active`, `Archived`。
- `next_phase_path` (str): 次フェーズの Draft ディレクトリ。
- `depends_on` (list[str]): 依存するファイル名。

## 4. 仕様策定タスク分割 (Specification Slicing)

| タスク ID | 仕様ファイル名 | 記述範囲と TDD 検証基準 |
| :---: | :--- | :--- |
| **S1-1** | `data/document_model.md` | メタデータ正規化ロジック、日本語キーマッピング、`status` 値域のバリデーション。 |
| **S1-2** | `logic/creation_logic.md` | 仮想キュー検知、Topological Sort、GitHub起票、Fail-fast エラーハンドリング。 |
| **S1-3** | `logic/promotion_logic.md` | PR Body 解析、`next_phase_path` 特定、ブランチ作成、`1 PR = 1 Task` 制約の適用。 |
| **S1-4** | `logic/roadmap_sync_logic.md` | Markdown テーブル内のリンク・番号置換の正規表現パターンとエッジケース。 |
| **S1-5** | `components/infra_adapters_v2.md` | `GitAdapter.get_added_files`, `GitHubAdapter.find_or_create_issue` 等のシグネチャ。 |
| **S1-6** | `api/cli_commands_v2.md` | `process-diff`, `process-merge` コマンドの引数と終了コード、例外の外部露出。 |

## 5. レビュー方針
- 「この仕様書を AI (Backend Coder) に渡しただけで、追加の質問なしにテストが書けるか？」を唯一の合格基準とする。
