# テスト仕様書: 仮想キューとフェーズ連鎖 (ADR-003)

- **Author(s)**: TECHNICAL_DESIGNER
- **Status**: 下書き
- **Last Updated**: 2026-01-04

## 1. 概要
本ドキュメントは、ADR-003「仮想キューと自己推進型ワークフロー」の実装を検証するためのテストシナリオと受け入れ条件（DoD）を定義する。
特に、GitHub Actions 上での「マージをトリガーとした自動起票」と「次フェーズへの自動連鎖」の論理的整合性と安全性を担保することに重点を置く。

## 2. テスト環境・前提
- **Unit Test**: インフラ層（Git/GitHub/FileSystem）をモックし、UseCase の論理フローを検証する。
- **Integration Test**: 模擬 Git リポジトリ環境を作成し、実際の `git` コマンドやファイル操作の連鎖を検証する。
- **GitHub API**: `GitHubAdapter` はモックを使用し、レートリミットや API エラーをシミュレートする。

## 3. テストシナリオ

### 3.1. 仮想キュー検知ロジック (Virtual Queue Detection)
`git diff-tree` を用いて `archive/` への新規追加ファイルを特定するロジックの検証。

| ID | 種別 | シナリオ | 期待される挙動 |
| :--- | :--- | :--- | :--- |
| VQ-001 | 正常 | `archive/` に新規 md ファイルが追加された場合 | 追加されたファイルのみが起票対象として抽出される。 |
| VQ-002 | 正常 | `archive/` への移動と同時に他ファイルが修正された場合 | 新規追加（A）のみが抽出され、修正（M）は無視される。 |
| VQ-003 | 境界 | `archive/` 内に既に Issue 番号を持つファイルが再配置された場合 | Frontmatter の `issue` フィールドを確認し、番号がある場合は起票対象から除外される。 |
| VQ-004 | 異常 | `archive/` に md 以外のファイル（画像等）が追加された場合 | 拡張子フィルタにより無視される。 |

### 3.2. 原子的一括起票 (Atomic Batch Creation)
複数タスクの一括起票と、失敗時の状態整合性の検証。

| ID | 種別 | シナリオ | 期待される挙動 |
| :--- | :--- | :--- | :--- |
| BC-001 | 正常 | 複数ファイル（依存関係なし）の一括起票 | 全ての Issue が作成され、各ファイルに番号が書き戻される。 |
| BC-002 | 正常 | 依存関係（`depends_on`）があるタスクの起票 | Topological Sort により依存元から順に起票され、本文内のファイル名が `#IssueNo` に置換される。 |
| BC-003 | 異常 | 起票プロセス中に 1 件でも API エラーが発生した場合 | **Fail-fast**: 以降の起票を中止し、ファイルへの書き戻しも行わない。作成済み Issue は「孤立」として残るが、Git は汚さない。 |
| BC-004 | 境界 | 部分失敗（BC-003）後の再実行（リトライ） | 失敗したバッチ内の全ファイルが再度起票され、孤立 Issue に対して二重起票が発生する。これが Git の整合性を優先した仕様上のトレードオフであることを確認する。 |
| BC-005 | 境界 | 50件を超える大量起票 | 設計されたバッチ分割（50件/バッチ）とインターバル（60秒）が発動し、リミットを回避して完遂する。 |

### 3.3. ロードマップ同期 (Roadmap Sync)
WBS テーブルのリンク置換と番号追記の検証。

| ID | 種別 | シナリオ | 期待される挙動 |
| :--- | :--- | :--- | :--- |
| RS-001 | 正常 | ロードマップ内のリンクが `drafts/` を指している場合 | `archive/` へのパス置換と、リンク末尾への ` (#No)` 追記が正しく行われる。 |
| RS-002 | 正常 | 1 つのロードマップに複数タスクのリンクがある場合 | 全ての対象行が正確に更新される。 |
| RS-003 | 異常 | ロードマップ内に対象タスクのリンクが見つからない場合 | **Error**: ロードマップとの不整合として処理を中断し、エラーログを出力する。 |

### 3.4. フェーズ連鎖 (Auto-PR)
次フェーズへの自動プロモートと PR 作成の検証。

| ID | 種別 | シナリオ | 期待される挙動 |
| :--- | :--- | :--- | :--- |
| AP-001 | 正常 | `next_phase_path` が設定された最終タスクがマージされた場合 | 新ブランチ作成、ファイル物理移動、コミット、PR作成が自動で行われる。 |
| AP-002 | 安全 | 同名の PR または Foundation ブランチが既に存在する場合 | 重複作成を避け、処理を安全にスキップ（または既存を維持）する。 |
| AP-003 | 安全 | 循環参照（P1 -> P2 -> P1）が発生した場合 | **Infinite Loop Protection**: 訪問済みパス検知により処理を中止し、警告を出力する。 |
| AP-004 | 境界 | フェーズ連鎖が 10 回（最大深度）連続した場合 | 安全装置により 10 回目で停止し、異常な増殖を防止する。 |

## 4. 期待されるログ出力 (Log Requirements)
トラブルシューティングのため、以下の主要イベントでログを出力すること。

- **起票開始**: `[INFO] Detected X new tasks in archive virtual queue.`
- **順序解決**: `[INFO] Resolving dependencies. Creation order: [T1-1, T1-2, ...]`
- **API 失敗**: `[ERROR] Failed to create issue for task-xxx. Stopping entire process to maintain atomicity.`
- **同期失敗**: `[ERROR] Task-ID TX-Y not found in roadmap roadmap-xxx.md. Inconsistency detected.`
- **循環検知**: `[WARN] Circular dependency detected in next_phase_path chain. Aborting Auto-PR creation.`
- **完了**: `[INFO] Successfully processed X tasks and updated roadmap.`

## 5. 受け入れ条件 (DoD)
- [ ] 上記全ての「正常」および「安全」系テストがパスすること。
- [ ] 「異常」系テストにおいて、Git リポジトリに中途半端な変更が Push されないこと（Fail-fast の実証）。
- [ ] 模擬環境での Phase 1 -> Phase 2 の自動リレーが 1 回の人間によるマージ操作で完結すること。
