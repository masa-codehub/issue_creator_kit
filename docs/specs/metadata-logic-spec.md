# 詳細設計: メタデータ操作ロジック (ADR-002)

## 1. 目的
ADR-002（ドキュメント承認フローの自動化）において、Markdownファイルのメタデータを柔軟かつ堅牢に読み取り・更新するための技術仕様を定義する。
本仕様では、既存資産との互換性と将来の拡張性を両立させるため、**ハイブリッドパースロジック（YAML Frontmatter 優先 + Markdown List フォールバック）** を採用する。

## 2. メタデータの構造

### 2.1. YAML Frontmatter (推奨)
ドキュメントの最上部に、YAML形式でメタデータを記述する。新規作成されるファイルはこの形式となる。

```markdown
---
key1: value1
status: Draft
list_key:
  - item1
  - item2
---
# タイトル
...
```

### 2.2. Markdown List Metadata (互換性維持)
ドキュメントの冒頭（主にタイトルの直後など）に、リスト形式でメタデータを記述する。既存のファイルはこの形式である場合がある。

```markdown
# タイトル

- **key1**: value1
- **status**: Draft
```

## 3. 操作ロジック (`Document.parse`)

メタデータの抽出は以下の優先順位とロジックで行われる。

### 3.1. Phase 1: YAML Frontmatter 解析
1. ファイルの先頭が `---` で始まっているかを確認する。
2. `---` で区切られたブロック（Frontmatter）を抽出し、`PyYAML` (`yaml.safe_load`) で辞書としてパースを試みる。
3. **成功した場合**: パースされた辞書をメタデータとし、以降の本文をコンテンツとして取得して終了する。
4. **失敗した場合** (例外発生時) または先頭が `---` でない場合: Phase 2 へ進む。

### 3.2. Phase 2: Markdown List Metadata 解析 (フォールバック)
1. ファイルを行単位で走査する。
2. 以下の正規表現パターンにマッチする行をメタデータとして抽出する。
   - **正規表現**: `r"^- \*\*([^*]+)\*\*: (.*)$"`
   - 例: `- **Status**: Open` -> Key: `Status`, Value: `Open`
3. **探索の終了条件**:
   - 以下のいずれかの条件を満たした時点で、メタデータ探索を終了する。
     - メタデータが一度でも見つかった後に、空行を含む当該正規表現にマッチしない行が現れた場合（その行以降を本文の開始とみなす）。
     - 行インデックスが **15** を超えた場合（つまり 16 行目以降）は、メタデータの有無にかかわらずそれ以降の行をメタデータ探索の対象にしない（パフォーマンスと誤検知防止のため）。

### 3.3. 更新・保存 (`Document.to_string`)
1. **推奨形式 (YAML)**: デフォルトでは YAML Frontmatter 形式で再構築して保存する。
2. **形式維持**: `FileSystemAdapter.update_metadata` が元のファイルの先頭が `---` で始まるかどうかをチェックして元形式（YAML Frontmatter か Markdown List か）を検出し、その結果に応じて `Document.to_string(use_frontmatter=...)` に適切な `use_frontmatter` パラメータを指定することで、既存ファイルの形式を維持したままメタデータを更新できる（実装は `src/issue_creator_kit/infrastructure/filesystem.py` の `update_metadata` に依存）。

## 4. エラーハンドリング
- **Frontmatter解析エラー**: YAML Frontmatterブロックの解析中に例外が発生した場合、例外を捕捉し、自動的に Markdown List 解析へフォールバックします。これにより、Frontmatter の記述ミスがあっても最低限の本文取得が可能となる場合があります。
- **ファイル読み込みエラー**: `FileNotFoundError` 等は呼び出し元（Adapter）で処理される。

## 5. 検証パターン

| ケース | 入力例 | 期待される動作 |
| :--- | :--- | :--- |
| **YAML (正常)** | `---`<br>`status: Draft`<br>`---` | Phase 1 で成功。`{"status": "Draft"}` を取得。 |
| **Markdown List (正常)** | `# Title`<br>`- **status**: Draft` | Phase 1 スキップ -> Phase 2 で成功。`{"status": "Draft"}` を取得。 |
| **YAML 構文エラー** | `---`<br>`key: value: error`<br>`---` | Phase 1 失敗（例外捕捉） -> Phase 2 へフォールバック（Phase 2 でもメタデータが検出されない場合は空の辞書 `{}` が返る）。 |
| **混在 (YAML優先)** | `---`<br>`a: 1`<br>`---`<br>`- **b**: 2` | Phase 1 が優先され `{"a": 1}` のみ取得。本文中のリストは本文として扱われる。 |
| **探索範囲外** | (17行目以降)<br>`- **key**: val` | Phase 2 の16行制限（インデックス15まで探索）により無視される。 |

## 6. 利用ライブラリ
- `PyYAML`: YAML解析
- `re` (標準ライブラリ): 正規表現によるテキスト解析
