# 概要 / Summary
[ADR-002] タイトル: ドキュメント承認フローとライフサイクル管理の自動化

- **Status**: 完了
- **Date**: 2025-12-31 (更新日: 2026-01-03)

## 状況 / Context
設計ドキュメント（ADR/Design Doc）がプルリクエストを経て承認（mainブランチへマージ）された際、手動で以下の作業を行う必要がある。
1. ファイル内の `Status` を「承認済み」に変更する。
2. `Date` または `Last Updated` をマージ日に更新する。
3. ファイルを `reqs/design/_inbox/` から `reqs/design/_approved/` へ移動する。
これらの作業は定型的でありながら忘れやすく、放置されると「どの設計が最新か」という SSOT（真実の単一ソース）としての信頼性が損なわれる。
本システムでは、このライフサイクル管理を完全に自動化し、人為的ミスを排除する必要がある。
また、ワークフローのロジックが YAML に散在しているとテストが困難であるため、ロジックを Python スクリプトに集約し、YAML は最小限の構成管理に留めるアーキテクチャを採用する。

## 決定 / Decision
<!-- 
【思考の指針】
- 下した決定を「ユビキタス言語」を用いて明確に記述してください。
-->
以下の方式を採用し、設計の承認から公式記録化、および実装トラッキング開始までのライフサイクルを自動化する。

### 1. アーキテクチャ方針: Clean Architecture Lite
CLIツールの実装において、テスト容易性と保守性を高めるため、以下の「関心の分離」を適用する。

- **Infrastructure層**: Git操作 (`subprocess`), GitHub API (`PyGithub`), ファイルシステム操作 (`open`) などの IO 処理を Adapter として実装する。
- **Usecase層**: 承認フローのビジネスルールやワークフロー全体の制御（オーケストレーション）を担当する。ここは純粋な Python コードであり、Infrastructure 層のインターフェースにのみ依存する（依存性逆転）。
- **Domain層**: ドキュメントやメタデータのデータ構造を定義する。
- **CLI層**: ユーザー入力（引数）を受け取り、Usecase に適切な Adapter を注入 (DI) して実行する。

これにより、IO を伴う処理（特に Git 操作）のテストにおいて、Infrastructure 層をモック化することでロジックの完全な検証が可能となる。

### 2. 責務と技術的手段の完全対応表 (Strict Mapping)

| 担当 (Actor) | 技術的手段 (Technical Means) | 具体的な成果物・動作 |
| :--- | :--- | :--- |
| **Architect** | **マージ操作** | `reqs/design/_inbox/` 内のファイルを `main` ブランチへマージする（これが承認の意思表示となる）。 |
| **issue-kit (CLI/Usecase)** | **ワークフロー実行 (`run-workflow`)** | YAML内のシェルスクリプトを排除し、Gitの変更検知からコミットまでの全行程を Usecase として実行する。 |
| **issue-kit (Usecase)** | **一括承認 (`process_all_files`)** | `_inbox` 内の全ファイルをスキャンし、移動・更新・Issue起票を一括で行う。 |
| **issue-kit (Infrastructure)** | **Git Adapter** | `git add`, `git commit` 等のコマンド発行をカプセル化する。 |
| **issue-kit (Infrastructure)** | **GitHub Adapter** | `PyGithub` を用いた Issue 起票や PR 作成操作をカプセル化する。 |
| **GitHub Actions** | **ワークフロー定義** | YAML は Python 環境のセットアップと `issue-kit run-workflow` の 1行呼び出しのみを担当する。 |

### 3. 詳細仕様規定
- **トラッキングIssueの内容**:
    - **タイトル**: ドキュメントの見出し（例：`# 概要 / Summary` の次の行）を採用。
    - **本文**: 承認済みファイルへのパーマリンクを含める。
- **置換・追記対象キー**:
    - `Status`: `承認済み` に更新。
    - `Date` / `Last Updated`: 実行日の日付に更新。
    - `Issue`: 起票されたトラッキングIssueの番号（例：`#123`）を新規に追記、または既存項目を更新する。

### 実装上の制約 (Constraints)
- **インフラ要件**: 本システムを Self-hosted runner で実行する場合、ランナーの OS 環境にあらかじめ GitHub CLI (`gh`) がインストールされており、`gh` コマンドが実行可能な状態でなければならない。

## 検討した代替案 / Alternatives Considered
- **案B: フラットなスクリプト構成**: `scripts/` にロジックをベタ書きする。
    - *不採用理由*: Phase 3 までの実装で採用していたが、Git 操作やファイル操作が混在し、単体テストで `subprocess` をパッチする箇所が複雑化するため、Phase 4 でリファクタリングする。
- **案C: マージ時に直接 main にコミット**:
    - *不採用理由*: マージ後の変更を直接 `main` に入れると、Branch Protection Rule（ブランチ保護ルール）に抵触する場合があり、安全性を考慮して PR 経由での最終確認フローを残す。

## 結果 / Consequences
### メリット (Positive consequences)
- 設計ドキュメントのステータスと物理的な配置が、承認実態と常に同期される。
- **IO の分離により、Git コマンドや API コールの失敗系も含めたテストカバレッジを 100% に近づけられる。**
- 承認済みフォルダ（`_approved/`）を見れば、常に最新かつ確定した設計のみが並んでいる状態が保証される。

### デメリット (Negative consequences)
- ファイル数やクラス数が増加し、初期実装コストが若干上がる（が、保守コスト低下で回収可能）。
- 自動作成された PR を再度マージするという 1 ステップが追加される。

## 検証基準 / Verification Criteria
1. `pytest` において、Infrastructure 層をモック化した状態で Usecase の全分岐がパスすること。
2. 実際の GitHub Actions 上で、`reqs/design/_inbox/` のファイルが正しく処理され、PR が作成されること。

## 実装状況 / Implementation Status
実装完了。Phase 4 のリファクタリングにより Clean Architecture Lite を適用。

## 付録: 実装上の懸念と今後の課題 (Technical Notes)
本 ADR の実装（Phase 4 時点）において、以下のエッジケースに関する懸念が識別されている。今後の機能改善の際に参照すること。

1. **ロールバック時のメタデータ不整合**:
   GitHub API 連携（Issue起票）が失敗してファイルが `_inbox` にロールバックされた際、先行して書き換えられた `Status: 承認済み` が元の状態に戻らない。このため、`_inbox` 内に承認済みステータスのファイルが残る可能性がある。
2. **Issue起票の冪等性**:
   同一ファイルに対して処理が再実行された際、既存の `Issue: #...` タグの有無をチェックしていないため、重複して Issue が起票される可能性がある。
3. **パーマリンクの完全性**:
   Issue 本文に含まれるドキュメントへのリンクが相対パスであり、GitHub 上のブラウジングにおいて期待通りに機能しない可能性がある。
