# 概要 / Summary
[ADR-001] タイトル: トポロジカルソートを用いた依存関係解決型Issue起票の採用

- **Status**: 提案中
- **Date**: 2025-12-27

## 状況 / Context
<!-- 
【思考の指針】
- 「なぜ今これが必要か？」というビジネス上の背景と技術的課題を記述してください。
- 解決すべき「真の問題」をドメインの視点から特定してください。
- 関連する既存のADRや技術的制約があれば明記してください。
-->
現在、設計ドキュメントから複数のタスク（Issue）を生成する際、タスク間の依存関係（例：タスクAが終わらないとタスクBに着手できない）を考慮して起票する標準的な仕組みが存在しない。
無秩序にIssueを起票すると、依存関係が不明確になり、開発者が着手順序を誤る、あるいは不完全な状態のタスクがバックログに滞留するという課題がある。
本システムでは、Markdownファイル内に記述された依存関係を自動的に解析し、正しい順序でGitHub Issueを生成する仕組みが必要である。

## 決定 / Decision
<!-- 
【思考の指針】
- 下した決定を「ユビキタス言語」を用いて明確に記述してください。
- クリーンアーキテクチャの原則（依存性のルール等）に則っているか確認してください。
- 技術的な詳細（ライブラリ名など）だけでなく、その背後にある設計思想を記述してください。
-->
以下の方式を採用し、**Dependency First（依存関係優先）** な起票を実現する。

### 責務と技術的仕様の統合 (Mapping of Responsibilities)

1.  **[AI Agent] (静的定義の作成)**
    - **役割**: アーキテクチャ設計を解釈し、Draft Issue を作成する。
    - **技術仕様 (依存定義)**: 依存関係を `- **Depends-On**: ./issue-XXX.md` のように **「相対ファイルパス」** で静的に記述する。これにより、Issue起票前の不確定な番号問題を回避する。

2.  **[issue-kit (src/)] (動的解決ロジック)**
    - **役割**: 依存関係の解析、順序制御、およびAPI通信を行う。
    - **技術仕様 (順序制御)**: Python の `graphlib.TopologicalSorter` を用い、ファイルパスから DAG を構築・ソートする。
    - **技術仕様 (番号の動的解決)**: 親Issue起票時に GitHub API から返却される **実Issue番号** をメモリ上で保持する。後続のIssue本文内にある「相対ファイルパス記述」を、この **「実Issue番号（#123）」へ実行時に動的に置換** して投稿する。
    - **技術仕様 (安全装置)**: 処理開始前に `/rate_limit` を確認し、残弾不足時は一貫性を守るため処理を1件も実行せずに停止する（Fail-Fast）。
    - **技術仕様 (循環検知)**: 循環参照を検知した場合、循環パス（A -> B -> A）をログに出力して停止する。

3.  **[GitHub Actions] (自動実行インフラ)**
    - **役割**: 本システムの実行環境を提供し、自動化をトリガーする。
    - **技術仕様 (自動実行)**: `main` ブランチへのマージをトリガーに、環境内で `issue-kit run` コマンドを実行し、自動起票プロセスを完遂させる。
    - **技術仕様 (認証管理)**: `GITHUB_TOKEN` を安全に供給し、GitHub API への認証済みアクセスを保証する。

## 検討した代替案 / Alternatives Considered
<!-- 
【思考の指針: Mark Richards の比較分析】
- 推奨案以外に検討したアプローチ（案B, 案C等）を記述してください。
- なぜそれらの案を採用しなかったのか、推奨案との決定的なトレードオフを明記してください。
-->
- **案B: 並列起票**: 依存関係を無視してすべてのIssueを同時に起票する。
    - *不採用理由*: 依存関係を整理する手間がユーザーに残るため、本システムの「管理コスト削減」という価値を十分に提供できない。
- **案C: 指数バックオフによるリトライ**: API制限時に待機する。
    - *不採用理由*: 長時間の待機はActionsの実行時間を消費し、また途中で失敗した場合の状態管理が複雑になる。本システムでは「事前チェックによる完全停止」を優先し、ユーザーに明示的な再実行を促す。

## 結果 / Consequences
<!-- 
【思考の指針: Mark Richardsのトレードオフ分析】
- 完璧な設計は存在しません。「何を得るために、何をあきらめたか」を誠実に記述してください。
- 4大リスク（価値・実現可能性・ユーザビリティ・ビジネス生存性）の観点から評価してください。
-->

### メリット (Positive consequences)
- 依存関係が解決された順にIssueが並ぶため、開発者が迷うことなくタスクに着手できる。
- Issue本文内で親タスクへのリンクが自動的に生成されるため、GitHub上でのナビゲーションが向上する。
- WBS段階での不整合（循環参照）が起票前に確実に検知され、プロジェクト管理の健全性が保たれる。

### デメリット (Negative consequences)
- 依存関係の記述ミスにより起票がブロックされる可能性がある。

## 検証基準 / Verification Criteria
<!-- 
【思考の指針: 仮説検証】
- この決定が正しく機能していることを、どのように客観的に計測・確認できるか記述してください。
-->
1.  依存関係（A -> B -> C）を持つ3つのMarkdownファイルを配置し、`issue-kit run` を実行した際、GitHub上で A, B, C の順にIssueが作成されること。
2.  Issue C の本文中に、Issue B への有効なリンク（例：#102）が自動挿入されていること。
3.  循環参照（A -> B -> A）を含むファイルを配置した際、エラーログに `Cycle detected: A -> B -> A` と表示され、起票が1件も行われないこと。
4.  API残弾数が不足している状況をシミュレートし、処理が安全に中断されること。

## 実装上の制約 (Constraints)
- **WBS設計時**: ロードマップ（WBS）の設計時に、依存関係をMermaid等で視覚化し、循環参照がないことを確認する指示をテンプレートに含めること。


## 実装状況 / Implementation Status
進行中
