# 概要 / Summary
[ADR-003] タイトル: 仮想キューと自己推進型ワークフローによるタスクライフサイクル管理

- **Status**: 承認済み (Updated: 2026-01-03)
- **Date**: 2026-01-01
- **Issue**: #71

## 状況 / Context
GitHub 上のプロジェクトにおいて、設計から派生する大量のタスクを効率的に管理するため、以下の「不確実性への適応」と「自動化の極致」を両立させる必要がある。
1. **遅延洗練（Lazy Update）**: 先行フェーズの結果を反映するため、タスクは起票直前まで柔軟に変更可能でなければならない。
2. **実行の明示性**: 何が起票され、何が完了しているかを Git の物理構造で明白に示さなければならない。
3. **自己推進（Self-Propelling）**: 人間の手動操作（フォルダ移動や PR 作成）を最小化し、実装の完了が自然に次フェーズの準備に繋がらなければならない。

## 決定 / Decision
物理的な実行待ちフォルダを排除した「仮想キュー（Virtual Queue）」方式と、メタデータに基づく「フェーズ連鎖」を採用する。

### 1. ディレクトリ構造とステータス定義

#### A. ロードマップ (`reqs/roadmap/`)
- **`_inbox/`**: 策定・提案中。
- **`active/`**: 実行中の SSOT。ICK により WBS 内のリンクが Draft から Archive（実 Issue 番号付き）へ動的に書き換えられる。
- **`archive/`**: プロジェクト完了。

#### B. タスク (`reqs/tasks/`)
- **`drafts/`**: **【待機と洗練の場】**。全フェーズのタスクが配置される。この段階ではただのファイルであり、変更コストが極めて低い。
- **`archive/`**: **【実行と成功の証跡】**。
    - **仮想キュー**: `drafts/` から `archive/` への **「移動 PR」** が作成された状態を Queue（起票待ち）と見なす。
    - **実行**: PR が `main` にマージされた瞬間、ICK が「新規に追加された未採番ファイル」を検知し、GitHub Issue を一括起票する。

### 2. 自己推進型ワークフロー（フェーズ連鎖）
フェーズの最後となる **レビュー Issue** のマージを合図に、ICK が次フェーズを自律的にセットアップする。

- **トリガー規約**:
    - 各フェーズの最終タスク（例: `Review & Merge`）の Frontmatter に `next_phase_path: "drafts/adr-xxx/phase-2/"` を記述する。
- **Actions による自動連鎖**:
    1. 最終タスク・ブランチの `main` マージを検知。
    2. ICK が `next_phase_path` を読み取り、`main` から **次フェーズ用 Foundation Branch** を作成。
    3. `drafts/` 内の次フェーズ・フォルダを `archive/` へ物理的に移動。
    4. **「次フェーズ起票 PR」** を `main` へ向けて自動作成する。

### 3. 自己更新型ロードマップ (Roadmap Sync)
タスクが起票（アーカイブ）された際、人間によるリンクの張り直しを排除する。
- **リンク置換**: `archive/` 移動時に、ロードマップ WBS 内の「Draft へのパス」を「Archive へのパス」に置換し、決定した Issue 番号（#XXX）をリンクの横に動的に追記する。

### 4. 再帰的フェーズブランチ戦略
- **Foundation Branch**: 各フェーズの基点。`main` から作成。
- **Task Branch**: Foundation から作成。完了後、Foundation へ戻す。
- **Phase Merge**: 全タスク完了後、Foundation を `main` へマージする。これが次フェーズへの連鎖トリガーとなる。

## 結果 / Consequences
### メリット
- **明白な実行トリガー**: 「PR のマージ」という Git の標準操作が、安全な一括起票のスイッチとなる。
- **履歴の純粋性**: `_queue/` などの途中の状態を排除し、作成（Draft）と完了（Archive）のみを記録。
- **継続的なリズム**: 開発者が最後のマージボタンを押した瞬間に、次の「燃料（次フェーズ PR）」が届く。

## 検証基準 / Verification Criteria
1. `archive/` への新規ファイル投入 PR がマージされた際、Issue が起票され #番号がファイルに書き戻されること。
2. ロードマップ内のリンクが自動で Archive 向けに更新されること。
3. `next_phase_path` を持つファイルがマージされた際、次フェーズの移動 PR が自動生成されること。