# 概要 / Summary
[ADR-003] タイトル: 仮想キューと自己推進型ワークフローによるタスクライフサイクル管理

- **Status**: 承認済み (Updated: 2026-01-03)
- **Date**: 2026-01-01
- **Issue**: #71

## 状況 / Context
GitHub を用いた高度なソフトウェア開発において、設計から派生する大量のタスクを効率的に管理し、かつプロジェクトを自律的に進行させるために、以下の課題を解決する必要がある。
1.  **不確実性への適応**: 先行フェーズの教訓を反映するため、未来のタスクは起票直前まで「下書き（Draft）」として柔軟に変更可能でなければならない。
2.  **物理的ステータスの明白性**: 何が計画中であり、何が実行され、何が完了したかを Git の物理的なディレクトリ構造で一目瞭然にしなければならない。
3.  **自動化の極致（自己推進）**: 人間による手動のファイル移動や PR 作成を最小化し、「一つの作業の完了」が「次の準備」を自動的に誘発する仕組みが必要である。
4.  **SSOT の自動維持**: ロードマップ（工程表）内のリンクや Issue 番号を手動で更新する手間を排除し、常に実体と同期させなければならない。

## 決定 / Decision
物理的な実行待ちフォルダを廃止した「仮想キュー（Virtual Queue）」方式と、レビュー完了をトリガーとした「フェーズ連鎖（Auto-PR）」、および「自己更新型ロードマップ」を採用する。

### 1. ディレクトリ構造と論理ステータス
物理的な配置がプロジェクトの「状態」を表現する SSOT として機能するよう設計する。

#### A. ロードマップ (`reqs/roadmap/`)
- **`_inbox/`**: 策定・提案中の計画。マージにより `active/` へ移動する。
- **`active/`**: 実行中の SSOT。
    - **自動更新**: ICK により WBS 内のリンクが `reqs/tasks/drafts/...` から `reqs/tasks/archive/...` へ動的に書き換えられる。
- **`archive/`**: プロジェクト完了後の記録。

#### B. タスク (`reqs/tasks/`)
- **`drafts/`**: **【待機と洗練の場】**。
    - 全フェーズのタスク（例: `adr-003/phase-1/`, `adr-003/phase-2/`）が先行生成される。
    - この段階では GitHub Issue は存在しない。先行フェーズの教訓に基づき、起票直前まで「遅延洗練」を行うための場所。
- **`archive/`**: **【実行と成功の証跡】**。
    - **仮想キュー (Virtual Queue)**: `drafts/` 内の特定フォルダを `archive/` へ移動させる **「プルリクエスト」** が Open である状態を Queue（起票待ち）と定義する。
    - **実行トリガー**: 上記 PR が `main` にマージされた瞬間（`push` イベント）、ICK が `git diff` で「`archive/` に新規追加された未採番ファイル」を検知し、GitHub Issue を一括起票する。

### 2. 再帰的フェーズブランチ戦略 (Nested Branching Strategy)
フェーズ途中の不安定なコードを `main` から隔離し、整合性を保護する。

1.  **Phase Start**: `main` からそのフェーズの基点となる **Foundation Branch** (例: `feature/phase-X-foundation`) を作成。
2.  **Task Life**: 
    - 各タスクは **Foundation Branch** から派生した **Task Branch** (例: `feature/task-T1-1-setup`) で実装。
    - 完了後、**Foundation Branch** へマージし、成果を集約する。
3.  **Phase End**: フェーズ最後のタスク（Review）の完了をもって、**Foundation Branch** を `main` へマージする。これが次フェーズへの連鎖合図となる。

### 3. 自己推進型ワークフロー（フェーズ連鎖）
本システムは以下の 8 ステップに従い、フェーズの進行と自動起票を連鎖させる。

1. **drafts/** から **archive/** への `*.md` の移動（**人間または AI エージェント**がプルリクエスト #1 を手動作成）
2. **プルリクエスト #1** を `main` にマージ
3. **Issue を自動起票**（移動した `*.md` のみ）
4. **人間または AI エージェント**が Issue を全て実装し、フェーズのブランチへマージ
5. **最終 Issue を完了**（フェーズのブランチを `main` にマージ）
6. **次のフェーズの *.md を drafts/ から archive/ へ移動**（プルリクエスト #N を自動起票）
   - ※最終 Issue の判定は、タスク定義の `next_phase_path` メタデータの有無等で行う。
7. **プルリクエスト #N** を `main` にマージ
8. **Issue を自動起票**。以下、その ADR/Design-Doc の Issue が全て処理されるまで続く。

### 4. 自己更新型ロードマップ (Roadmap Sync)
タスク起票時にロードマップとの整合性を自動で維持する。

- **リンク置換アルゴリズム**:
    - `archive/` への移動（起票）フェーズにおいて、ICK は対象タスクのメタデータから `roadmap` パス（例: `reqs/roadmap/active/roadmap-xxx.md`）を特定。
    - ロードマップ内の WBS テーブルを行単位でスキャン。
    - 対象タスクのファイルパス（例: `../../tasks/drafts/issue-T1.md`）を検出し、`../../tasks/archive/issue-T1.md` に置換。
    - さらに、決定した実 Issue 番号（例: `#123`）をリンクテキストの横、または備考欄に動的に追記する。

### 5. 原子的な起票 (Atomic Execution)
- **All-or-Nothing**: マージされたフォルダ内の全タスクが正常に起票できた場合のみ、Issue 番号のファイル書き戻しおよびロードマップ更新を行い、変更をコミットする。
- **PR ベースの信頼性**: PR のマージという不可逆操作を起票の確定とし、途中の失敗による二重起票を構造的に防止する。もし起票処理中にエラーが発生した場合、ICK はエラーを通知し、人間による再試行（または手動リカバリ）を待つ。

## 検討した代替案 / Alternatives Considered
- **案A: 物理的な `_queue/` フォルダの維持**: Git 履歴に「一時的な移動」が記録されノイズとなるため、PR 自体をキューとする「仮想キュー」案を採用し却下。
- **案B: 全タスク同時起票**: 変化する要求に対する修正コストが極大化するため、`drafts/` による「遅延洗練」案を採用し却下。

## 結果 / Consequences
### メリット
- **極めてクリーンな履歴**: 成果物は `Draft`（作成）から `Archive`（完了）へ一足飛びに移動し、ノイズがない。
- **自律的開発リズム**: マージボタンを押すたびに、次のフェーズの準備が整う「自己推進型」の体験を提供。
- **不確実性への強さ**: 起票直前まで `drafts/` でタスクを修正できるため、アジャイルな設計変更に対応可能。

### デメリット
- システムによる Markdown（ロードマップ）の機械的書き換えが発生するため、競合に注意が必要。
- GitHub Actions における「差分検知」ロジックの実装コストが若干高い。

## 検証基準 / Verification Criteria
1.  **仮想キュー**: `archive/` への移動 PR がマージされた際、対象ファイルが Issue 化され、メタデータ（`issue: #XXX`）が更新されること。
2.  **フェーズ連鎖**: `next_phase_path` を持つファイルが `main` に入った直後、次フェーズの移動 PR が自動で Open されること。
3.  **ロードマップ同期**: 起票されたタスクに関連するロードマップのリンクが、人間を介さず最新化（Draft -> Archive置換）されること。
4.  **原子性**: 通信エラー等で起票が 1 件でも失敗した場合、中途半端な Issue 番号の書き込みが行われず、不整合が発生しないこと。

## 補足: 原子性と不整合に関するトレードオフ (Refined Decision)
### Fail-Fast 戦略による重複の許容
本アーキテクチャでは、**Git リポジトリを唯一の正解 (SSOT) として守り抜くこと**を最優先事項とする。
そのため、GitHub Actions での起票プロセスが通信エラー等で中途半端に失敗した場合、以下の戦略を採る。

1.  **Git への書き込み禁止**:
    - 全ての Issue 起票が成功するまで、ファイル（Frontmatter）への番号書き戻しやコミットは一切行わない。
    - 1件ごとの逐次コミットは履歴を汚染するため採用しない。

2.  **重複（二重起票）の許容**:
    - 処理が中断された場合、GitHub 上には「作成済みだがファイルに記録されていない Issue」が残る（孤立 Issue）。
    - 次回の再実行時、システムは Git の状態（未採番）を正として再度全件の起票を行うため、結果として Issue が重複する。
    - この重複は、Git の状態不整合（書き損じ）を防ぐための「安価なコスト」として許容する。

3.  **ロールバックの放棄**:
    - 失敗時に API で Issue を削除（Close）しようとする複雑なロールバック処理は実装しない（エラー処理中のエラーを防ぐため）。
    - 孤立 Issue は運用で手動 Close するか、無視する。
