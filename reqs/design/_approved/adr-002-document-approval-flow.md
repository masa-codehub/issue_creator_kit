# 概要 / Summary
[ADR-002] タイトル: ドキュメント承認フローとライフサイクル管理の自動化

- **Status**: 提案中
- **Date**: 2025-12-27

## 状況 / Context
設計ドキュメント（ADR/Design Doc）がプルリクエストを経て承認（mainブランチへマージ）された際、手動で以下の作業を行う必要がある。
1. ファイル内の `Status` を「承認済み」に変更する。
2. `Date` または `Last Updated` をマージ日に更新する。
3. ファイルを `reqs/design/_inbox/` から `reqs/design/_approved/` へ移動する。
これらの作業は定型的でありながら忘れやすく、放置されると「どの設計が最新か」という SSOT（真実の単一ソース）としての信頼性が損なわれる。
本システムでは、このライフサイクル管理を完全に自動化し、人為的ミスを排除する必要がある。

## 決定 / Decision
<!-- 
【思考の指針】
- 下した決定を「ユビキタス言語」を用いて明確に記述してください。
-->
以下の方式を採用し、設計の承認から公式記録化、および実装トラッキング開始までのライフサイクルを自動化する。

### 1. 責務と技術的手段の完全対応表 (Strict Mapping)

| 担当 (Actor) | 技術적手段 (Technical Means) | 具体的な成果物・動作 |
| :--- | :--- | :--- |
| **Architect** | **マージ操作** | `reqs/design/_inbox/` 内のファイルを `main` ブランチへマージする（これが承認の意思表示となる）。 |
| **issue-kit (src/)** | **メタデータ置換** | `Status` を `承認済み` へ、日付を `当日` へ、さらに作成した `Issue番号` をファイル内に自動追記する。 |
| **issue-kit (src/)** | **トラッキングIssue起票** | 承認されたドキュメントに対し、`[ADR-XXX]` 等のタイトルで GitHub Issue を作成する。これが後続タスクの親となる。 |
| **issue-kit (src/)** | **ファイル移動** | `git mv -f` を用いて、ファイルを `reqs/design/_approved/` へ移動させる。 |
| **GitHub Actions** | **自動PR作成 & 自動マージ** | 更新されたファイル群を新ブランチにプッシュし、`gh pr create` 直後に `gh pr merge --auto` を実行して `main` への反映を完遂させる。 |
| **AI / Developer** | **単体テスト (pytest)** | メタデータ置換やファイル操作の正確性を担保するため、GitHub API 通信を擬似化したテストを事前に作成・検証する。 |
| **GitHub Actions** | **統合テスト (act)** | ワークフロー全体（PR作成、自動マージ、CLI呼び出し）の正当性を、ローカルの Docker 環境で事前に検証する。 |

### 2. 詳細仕様規定
- **トラッキングIssueの内容**:
    - **タイトル**: ドキュメントの見出し（例：`# 概要 / Summary` の次の行）を採用。
    - **本文**: 承認済みファイルへのパーマリンクを含める。
- **置換・追記対象キー**:
    - `Status`: `承認済み` に更新。
    - `Date` / `Last Updated`: 実行日の日付に更新。
    - `Issue`: 起票されたトラッキングIssueの番号（例：`#123`）を新規に追記、または既存項目を更新する。
- **トレーサビリティの連鎖**: AI エージェントが具体的タスク（Draft Issue）を生成する際、このトラッキングIssue番号を参照することで、設計からタスクまでのグラフ構造を維持する。
- **自動マージの前提条件**: リポジトリ設定で "Allow auto-merge" が有効であること、および CI チェックがパスしていること。

### 実装上の制約 (Constraints)
- **インフラ要件**: 本システムを Self-hosted runner で実行する場合、ランナーの OS 環境にあらかじめ GitHub CLI (`gh`) がインストールされており、`gh` コマンドが実行可能な状態でなければならない。

## 検討した代替案 / Alternatives Considered
- **案B: 手動更新後のマージ**: 開発者が PR 内で手動で Status を変えてからマージする。
    - *不採用理由*: 人為的ミスを 100% 防げず、また「マージされた瞬間に承認済みになる」という実態と乖離するため。
- **案C: マージ時に直接 main にコミット**:
    - *不採用理由*: マージ後の変更を直接 `main` に入れると、Branch Protection Rule（ブランチ保護ルール）に抵触する場合があり、安全性を考慮して PR 経由での最終確認フローを残す。

## 結果 / Consequences
### メリット (Positive consequences)
- 設計ドキュメントのステータスと物理的な配置が、承認実態と常に同期される。
- 人間がメタデータの更新という「瑣末な作業」から解放される。
- 承認済みフォルダ（`_approved/`）を見れば、常に最新かつ確定した設計のみが並んでいる状態が保証される。

### デメリット (Negative consequences)
- 自動作成された PR を再度マージするという 1 ステップが追加される。

## 検証基準 / Verification Criteria
1. `reqs/design/_inbox/test.md` をマージした際、GitHub Actions が起動し、`reqs/design/_approved/test.md` へ移動されること。
2. 移動後のファイル内の `Status` が `承認済み` になっていること。
3. `main` ブランチに対して自動 PR が作成され、自動マージがスケジュールされること。
4. `pytest` によるロジック検証がパスし、`act` によるローカルワークフロー実行が正常終了すること。

## 実装状況 / Implementation Status
未着手
