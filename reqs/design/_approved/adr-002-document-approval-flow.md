# 概要 / Summary
[ADR-002] タイトル: ドキュメント承認フローとライフサイクル管理の自動化

- **Status**: 承認済み
- **Date**: 2025-12-31

## 状況 / Context
設計ドキュメント（ADR/Design Doc）がプルリクエストを経て承認（mainブランチへマージ）された際、手動で以下の作業を行う必要がある。
1. ファイル内の `Status` を「承認済み」に変更する。
2. `Date` または `Last Updated` をマージ日に更新する。
3. ファイルを `reqs/design/_inbox/` から `reqs/design/_approved/` へ移動する。
これらの作業は定型的でありながら忘れやすく、放置されると「どの設計が最新か」という SSOT（真実の単一ソース）としての信頼性が損なわれる。
本システムでは、このライフサイクル管理を完全に自動化し、人為的ミスを排除する必要がある。
また、ワークフローのロジックが YAML に散在しているとテストが困難であるため、ロジックを Python スクリプトに集約し、YAML は最小限の構成管理に留めるアーキテクチャを採用する。

## 決定 / Decision
<!-- 
【思考の指針】
- 下した決定を「ユビキタス言語」を用いて明確に記述してください。
-->
以下の方式を採用し、設計の承認から公式記録化、および実装トラッキング開始までのライフサイクルを自動化する。

### 1. 責務と技術的手段の完全対応表 (Strict Mapping)

| 担当 (Actor) | 技術적手段 (Technical Means) | 具体的な成果物・動作 |
| :--- | :--- | :--- |
| **Architect** | **マージ操作** | `reqs/design/_inbox/` 内のファイルを `main` ブランチへマージする（これが承認の意思表示となる）。 |
| **issue-kit (src/)** | **一括承認コマンド** | `issue-kit approve-all` コマンドにより、`_inbox` 内の全ファイルをスキャンし、移動・更新・Issue起票を一括で行う。ループ処理や条件分岐はこのコマンド内にカプセル化される。 |
| **issue-kit (src/)** | **メタデータ置換** | `Status` を `承認済み` へ、日付を `当日` へ、さらに作成した `Issue番号` をファイル内に自動追記する。 |
| **issue-kit (src/)** | **トラッキングIssue起票** | 承認されたドキュメントに対し、`[ADR-XXX]` 等のタイトルで GitHub Issue を作成する。これが後続タスクの親となる。 |
| **GitHub Actions** | **ワークフロー実行** | YAML は Python 環境のセットアップと `issue-kit approve-all` の実行、そして結果（Git差分）に基づく PR 作成のみを担当する。 |
| **AI / Developer** | **単体テスト (pytest)** | 承認ロジック全体（ファイル操作、Git操作、APIコール）を Python コードとして実装し、モックを用いた単体テストで品質を担保する。 |

### 2. 詳細仕様規定
- **トラッキングIssueの内容**:
    - **タイトル**: ドキュメントの見出し（例：`# 概要 / Summary` の次の行）を採用。
    - **本文**: 承認済みファイルへのパーマリンクを含める。
- **置換・追記対象キー**:
    - `Status`: `承認済み` に更新。
    - `Date` / `Last Updated`: 実行日の日付に更新。
    - `Issue`: 起票されたトラッキングIssueの番号（例：`#123`）を新規に追記、または既存項目を更新する。
- **テスタビリティ**: ロジックを Python スクリプトに寄せることで、Docker がない環境でも `pytest` により大部分の検証を可能にする。

### 実装上の制約 (Constraints)
- **インフラ要件**: 本システムを Self-hosted runner で実行する場合、ランナーの OS 環境にあらかじめ GitHub CLI (`gh`) がインストールされており、`gh` コマンドが実行可能な状態でなければならない。

## 検討した代替案 / Alternatives Considered
- **案B: YAML 内でのループ処理**: シェルスクリプトでループや条件分岐を書く。
    - *不採用理由*: テストが困難であり、複雑なロジック（エラーハンドリングや条件分岐）が増えると保守性が下がるため。
- **案C: マージ時に直接 main にコミット**:
    - *不採用理由*: マージ後の変更を直接 `main` に入れると、Branch Protection Rule（ブランチ保護ルール）に抵触する場合があり、安全性を考慮して PR 経由での最終確認フローを残す。

## 結果 / Consequences
### メリット (Positive consequences)
- 設計ドキュメントのステータスと物理的な配置が、承認実態と常に同期される。
- ロジックが Python コード化されることで、単体テストが容易になり、品質が向上する。
- 承認済みフォルダ（`_approved/`）を見れば、常に最新かつ確定した設計のみが並んでいる状態が保証される。

### デメリット (Negative consequences)
- 自動作成された PR を再度マージするという 1 ステップが追加される。

## 検証基準 / Verification Criteria
1. `pytest` によるロジック検証がパスすること。
2. 実際の GitHub Actions 上で、`reqs/design/_inbox/` のファイルが正しく処理され、PR が作成されること。

## 実装状況 / Implementation Status
実装中 (T3-3)
