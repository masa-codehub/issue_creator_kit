# 概要 / Summary
[ADR-003] タイトル: ロードマップおよび実装タスクのライフサイクル管理と自動化

- **Status**: 承認済み
- **Date**: 2025-12-28

## 状況 / Context
ADR-002 により、設計ドキュメント（ADR/Design Doc）の承認フローは定義された。
しかし、プロジェクトの進行に伴い更新され続ける「ロードマップ」や、使い捨ての実装指示書である「タスク（Draft Issue）」は、設計ドキュメントとは異なるライフサイクルを持つ。
これらを同一の `_inbox` / `_approved` フローで扱うと、承認済みの不変な仕様と、流動的な計画・タスクが混在し、管理が複雑化する。
特にタスク（Draft Issue）は、特定のタイミング（フェーズ開始時など）で GitHub Issue として起票されるべきであり、マージされた瞬間に全て起票されるとバックログが溢れる問題がある。

## 決定 / Decision
ロードマップとタスクに対し、設計ドキュメントとは独立した専用のディレクトリ構造とライフサイクルを定義し、自動化する。

### 1. ドメインモデリングと境界の画定
本システムにおける「タスク」と「計画」を以下の通り定義し、管理対象を明確にする。

- **【計画 (Roadmap)】**: プロジェクトの目的地と道筋。承認後も進捗状況や WBS の具体化に合わせて更新され続ける **Mutable（可変）** な集約。
- **【タスク案 (Task Draft)】**: 実装レベルの指示書。フェーズが来るまで発行されない **Transient（一時的）** なデータ。
- **【キュー (Queue)】**: 実装開始（Issue起票）を待機する物理的な「列」。

### 2. ディレクトリ構造と状態遷移
以下の構造を採用し、物理的な配置が論理的なステータスを表すように設計する。

#### ロードマップ (`reqs/roadmap/`)
- `_inbox/`: 策定中（提案フェーズ）。
- `active/`: 実行中。マージによりここへ移動され、プロジェクト終了までここに滞在する。
- **承認プロセス**: `_inbox` から `active` への移動は、Architect による手動移動（git mv）と PR マージによって行う。
- `archive/`: 完了済み。

#### タスク (`reqs/tasks/`)
- `drafts/`: 未発行。ADR ID/Phase 別に階層化され、人間がタイミングを判断する。
- `_queue/`: **【自動起票トリガー】**。ここへ配置されることが「着手」の意思表示となる。
- `archive/`: 起票済み。GitHub Issue 番号が追記されたログ。

### 3. 自動化ロジック (ICK Automation)
- **Queue Monitor**:
    - GitHub Actions が `reqs/tasks/_queue/` へのファイル追加（`main` ブランチへの push/merge）を検知し、ワークフローを起動する。
    - **階層構造の維持**: `_queue/` 内のサブディレクトリ（例: `adr-002/phase-1/`）も再帰的にスキャン対象とする。これにより、起票対象のタスクがどの文脈に属するかを維持したまま投入できる。
    - **階層的なトリガー**: PR 段階では起票せず、`main` に確定した時点でのみ起票する。
- **Atomic Archiving (一括コミット)**:
    - 投入された全てのタスクについて、依存関係解決と API 残弾チェック（Fail-Fast）を行う。
    - 全て正常に起票できた場合のみ、全ファイルを `archive/` へ移動する。この際、`_queue/` 内の階層構造（`adr-XXX/phase-Y/`）を維持したまま `archive/` へ配置し、**1回のコミット** で Git に反映させる。


## 検討した代替案 / Alternatives Considered

| 比較項目 | 案A (フォルダベース・キュー) | 案B (ラベル/メタデータ制御) |
| :--- | :--- | :--- |
| **設計の核心** | フォルダ移動という物理操作をトリガーにする | 全て1箇所に置き、内部の状態記述で制御する |
| **4大リスク評価** | 実現/UI: 高、生存性: 高 | 実現: 中、UI: 低（視認性欠如） |
| **主要なトレードオフ** | フォルダ階層が深くなる / 状態が明白 | 構造はシンプル / 操作ミスによる誤起票リスク |
| **推奨理由** | Git の Diff で「起票されたこと」が明確に記録されるため | - |

## 結果 / Consequences
### 4大リスク評価結果
- **[価値: 高]**: バックログの混乱を防ぎ、開発者の認知負荷を最小化する。
- **[実現可能性: 高]**: 既存の ICK ロジックの拡張で対応可能。
- **[ユーザビリティ: 中]**: ファイル移動操作が必要。CLI コマンド (`ick stage-task`) での支援を検討。
- **[ビジネス生存性: 高]**: 実行ログ（archive）が Git 上に残るため、GitHub 障害時もタスク内容を復旧できる。

## 検証基準 / Verification Criteria
1. `reqs/tasks/drafts/` にあるファイルを `reqs/tasks/_queue/` に移動して `main` にマージすると、GitHub Issue が起票されること。
2. 起票後、ファイルが `reqs/tasks/archive/` に移動され、単一のコミットで履歴に残っていること。
3. ロードマップファイルが `reqs/roadmap/active/` に配置され、継続的に更新可能であること。

## 実装状況 / Implementation Status
完了

---
- **Absolute Final Trigger**: Thu Jan  1 14:10:00 UTC 2026
