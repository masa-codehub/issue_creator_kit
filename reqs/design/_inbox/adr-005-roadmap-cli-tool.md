# 概要 / Summary
[ADR-005] グラフ理論に基づくタスク構造化支援ツールの導入

- **Status**: 提案中
- **Date**: 2026-01-14

## 状況 / Context
承認された ADR や Design Doc から実装タスクを抽出・構造化する際、タスク間の依存関係は複雑な DAG（有向非巡回グラフ）を形成する。
現在、エージェントはこれらを単一のスキル内で「記憶」と「推論」によって管理しようとしているが、以下の課題が顕在化している：
1. **網羅性の欠如**: 大規模な設計において、再帰的な依存解決（バックワード・チェイニング）中に「未解決のインプット（Missing Inputs）」の追跡が漏れ、ロードマップに穴が開く。
2. **論理矛盾の許容**: 循環参照の検出やトポロジカルソート（実行順序の決定）を LLM の推論のみに頼っており、客観的な整合性チェックが存在しない。
3. **コンテキストの圧迫**: 全てのタスク定義と成果物の関係をプロンプト内に保持し続ける必要があり、詳細な実装手順の記述に割くべき思考リソースが削られている。

## 決定 / Decision
論理的整合性の維持（グラフ理論の計算）を機械的な Python スクリプトに委譲し、エージェントは意味的な判断に特化するハイブリッド・ワークフローを採用する。

1. **管理ツール (`roadmap-manager.py`) の導入**:
    - YAML 形式でタスクと成果物（Artifact）の依存グラフを永続化・管理する CLI ツールを開発する。
    - 循環参照の検出、未解決インプットの抽出、実行順序の階層化（Leveling）をスクリプトで機械的に実行する。
2. **成果物の論理ID管理**:
    - ファイル名重複を避けるため、論理的な ID (`ART-xxx`) で入出力を定義し、物理パスとのマッピングを管理する。
    - コード（実装+テスト）や文書（要件+設計）をペアで一つの論理成果物として扱う。
3. **エージェントスキルのモジュール化**:
    - **`roadmap-orchestrator`**: ツールの `status` を監視し、計画全体の進捗を指揮する。
    - **`task-definition-analyst`**: 特定の「未解決インプット」に対し、それを生成するタスクの入出力を定義することに専念する。
    - **`task-drafting-writer`**: 確定したグラフ構造に基づき、個別の Issue Draft を詳細化する。

## 検討した代替案 / Alternatives Considered
- **案B (全自律型特化エージェント)**:
    - 高度なプロンプトエンジニアリングで LLM 内にグラフを持たせる案。実現性が低く、ステートのハルシネーションを完全に防げないため却下。
- **案C (厳格な Markdown テンプレートによる手動管理)**:
    - ツールを使わず、grep 等で依存関係を追跡する案。エージェントの作業負荷が高く、ミスが発生しやすいためスケールしないと判断。

## 結果 / Consequences
### メリット (Positive consequences)
- グラフ理論に基づいた厳密な依存関係管理が可能になり、計画の手戻りがなくなる。
- エージェントの役割が「最小単位の判断」に分割されるため、ハルシネーションが抑制され品質が向上する。
- 並列実行可能なタスクが明確になり、最短経路での目標達成が可能になる。

### デメリット (Negative consequences)
- ツールの初期開発コストおよび保守コスト。
- エージェントがツール操作（CLI インターフェース）を学習・遵守する必要がある。

## 検証基準 / Verification Criteria
- 20件以上のタスクを含む複雑な設計に対しても、循環参照なしにゴールから既存資産までのパスが構築できること。
- ロードマップ生成後に「実行不能なタスク（インプット不足）」が一件も発生しないこと。
- エージェントが個別のタスク詳細を記述する際、ツールが提示するインプット以外を参照せずに完了できること。

## 実装状況 / Implementation Status
未着手