# 概要 / Summary
[ADR-006] 自律分散型タスク管理と並列実行ワークフロー (Issue-as-Code)

- **Status**: 提案中
- **Date**: 2026-01-14

## 状況 / Context
AIエージェントによる開発規模が拡大するにつれ、従来の `.gemini/todo.md` を用いた「シングルスレッドな順次実行」では、以下の課題を解決できないことが判明しました。

1.  **並列性のボトルネック:** 複数のエージェントが同時に異なるタスクを進めるための標準的な仕組みがなく、AIの計算資源を最大化できない。
2.  **設計と実装の乖離リスク:** ADRやArchitecture図で決定された抽象的な「意図」が、具体的かつ厳密な「実装指示（Issue）」として下流フェーズに連鎖する仕組みが不足している。
3.  **マージの収束と依存関係:** ブランチが多岐にわたる中で、ドキュメントの先行修正と実装の着手タイミングの整合性を保ちつつ、`main` ブランチへ確実に収束させる運用ルールが必要である。
4.  **AIの指示品質:** 大量のIssueを自律起票させると、誤った指示に基づく「誤実装の量産」が起きる懸念がある。

## 決定 / Decision
「フェーズは直列、タスクは並列」という原則を掲げ、**「Issue-as-Code」** モデルによる自律分散ワークフローを採用します。

### 1. 螺旋階段型フェーズ管理 (Spiral Refinement)
一直線のウォーターフォールではなく、以下の順序でSSOT（正解）の解像度を上げていきます。
- **Architecture (Rough):** ADRを元に、大まかなコンポーネント構成を定義。
- **Spec (Detail):** I/Fやスキーマを詳細化。必要に応じてArchへフィードバック。
- **Implementation (TDD):** Fixしたドキュメントを「パスすべき要件」としてコードを実装。

### 2. 計画と実行の分離 (Planner/Executor Model)
- **Planner (上流):** `architecture-planning` や `spec-planning` は、自身の作業手順ではなく、**「並列実行可能なIssue案（Markdown）」** を `reqs/tasks/drafts/` に出力することに責任を持つ。
- **Review Gate (人間):** 出力されたIssue案をPull Requestとしてレビューし、タスクの粒度、依存関係、設計意図との整合性を承認する。
- **Automation:** マージをトリガーに `issue_creator_kit` がGitHub Issueを自動起票する。
- **Executor (下流):** 割り当てられた1つのIssueに対し、`todo-management` を使って自律的に実装を完遂する。

### 3. ブランチ収束戦略
- **都度マージ原則:** ドキュメント（ADR/Arch/Spec）は、次のフェーズ（または実装）の着手前に必ず `main` に収束させる。
- **予約と実行の分離:** Planningフェーズ（予約）は並行・連鎖的に行って良いが、Executionフェーズ（実際の作業）は親タスクが `main` にマージされた後に `main` からブランチを切って開始する。

## 検討した代替案 / Alternatives Considered
- **案A: 既存の `.gemini/todo.md` の拡張:** 競合が避けられず、AIエージェントの増員メリット（並列性）を活かせないため却下。
- **案B: エージェントによる直接Issue起票:** AIが誤った判断で大量のIssueを生成した場合の「Scale of Error」のリスクが許容できないため、PRによる人間レビュー（Gate）を必須とした。

## 結果 / Consequences

### メリット (Positive consequences)
- **スケーラビリティ:** 承認されたIssueを一斉に複数のエージェントにばら撒くことが可能になり、開発速度が飛躍的に向上する。
- **品質の安定:** 「指示書（Issue）」自体がコードとしてレビュー・管理されるため、設計意図の取りこぼしが激減する。
- **トレーサビリティ:** `reqs/tasks/` にタスクの履歴が残り、ADRから実装までの経緯が完璧に可視化される。

### デメリット (Negative consequences)
- **管理コスト:** MarkdownファイルによるIssue管理とPRレビューという、人間側のオーバーヘッドが若干増加する。
- **学習コスト:** エージェントに対して「自分自身のタスク管理」ではなく「Issueの設計」をさせるという高度なマインドセットが必要になる。

## 検証基準 / Verification Criteria
- [ ] `architecture-planning` 等の成果物が、`.gemini/todo.md` から `reqs/tasks/drafts/*.md` への出力に切り替わっていること。
- [ ] Issue案のPRレビューを通じて、不適切なタスク分割が事前に検知・修正できること。
- [ ] 承認されたIssueに基づき、複数のエージェントが並列でPRを作成・統合できること。

## 実装状況 / Implementation Status
進行中（本ADRに基づきスキル定義を修正予定）
