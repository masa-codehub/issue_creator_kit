# 概要 / Summary
[ADR-004] タイトル: 承認プロセスにおけるドキュメント内容の自動転記と Issue の Upsert 化

- **Status**: 提案中
- **Date**: 2026-01-02

## 状況 / Context
現在の Issue Creator Kit (ICK) は、ドキュメントが承認される（`main` へマージされる）際に GitHub Issue を作成するが、その内容はタイトルのみであり、本文は空の状態である。
また、承認済みドキュメントの修正（更新）が発生した際、その変更内容が GitHub Issue にリアルタイムで反映されないため、Issue を閲覧する開発者が最新の設計を把握できない課題がある。

## 決定 / Decision

### 1. フォルダ役割の固定
- **`reqs/design/_inbox/`**: 新規提案（未承認）のドキュメントのみを配置。
- **`reqs/design/_approved/`**: 承認済みドキュメントを配置。更新時もこのフォルダ内で直接編集を行う。

### 2. フローの分離

#### A. 新規承認フロー
- **対象**: `_inbox` 内の **Issue 番号がない** ファイル。
- **トリガー**: **`main` ブランチへのマージ**。
- **詳細ステップ**:
    1. `main` へのマージを検知し、自動化ワークフローが起動。
    2. GitHub Issue を新規作成（採番）し、ドキュメントの最新本文を転記。
    3. ファイルを `_approved` へ移動。
    4. 移動後のファイルに対し、ステータス（承認済み）、日付（当日）、Issue 番号（#XXX）を書き戻し。
    5. これらの変更を**専用の作業ブランチ**にコミット・プッシュ。
    6. `main` に対して、変更を反映するための**事後処理 PR を自動起票**。
- **意図**: 公式な承認（`main` への合流）が得られるまで、フォルダ移動と採番を行わない原則を維持しつつ、自動化された変更を最終的に人間が確認できる安全性を確保する。

#### B. 既存同期フロー（更新対応）
- **対象**: `_approved` 内のファイル。
- **トリガー**: **プルリクエスト（PR）内でのプッシュ、または任意のブランチへのプッシュ**。
- **振る舞い**:
    - ファイル内の Issue 番号を基に、GitHub Issue の本文を即座に更新（Upsert）する。
    - ファイル移動は発生しない。
- **意図**: `main` にマージされる前の修正段階であっても、GitHub Issue を常に最新の設計図として機能させる。

### 3. 同期仕様
- **同期範囲**: YAML フロントマター (`---`) ブロックを除いた、タイトル (`# `) を含む本文すべて。フロントマターが存在しないファイルは現状サポート対象外。
- **ガイドメッセージ**: Issue 本文冒頭に「Git が SSOT である」旨の警告文を自動挿入する。

### 4. 実装ガイドライン（詳細設計）
- **無駄な同期の回避**: GitHub Actions の `paths` フィルタを活用し、`reqs/design/` 配下の対象ファイルに変更が含まれないプッシュでは同期処理を起動させない。
- **再帰・ループの許容**: 新規承認時の事後処理 PR 作成時に、一度だけ重複して同期 API が呼び出される可能性があるが、ロジックの単純化を優先し、このコストは許容する。
- **Issue 番号の形式**: テンプレートで定義された `Issue: #XXX` 形式を唯一の正解とし、ユーザーによる手動の変則的な修正は考慮しない。
- **ステータスの不一致**: 更新 PR 中、ファイル内のステータスが「承認済み」のまま内容が変更されている状態は「仕様」として許容する。常に Git 上のコンテンツを真実の単一ソース (SSOT) とする。

## 検討した代替案 / Alternatives Considered
- **案A: 更新時も `_inbox` に戻す**
    - フォルダの往復による自動化ロジックの複雑化（再帰的な移動 PR など）を避けるため却下。

## 結果 / Consequences
### メリット
- ワークフローが「新規＝移動あり」「更新＝移動なし」と極めてシンプルになる。
- 開発中の設計変更が即座に Issue に反映され、チーム内の情報断絶が解消される。
- `_approved` にあるドキュメントは常に最新の承認済み（または更新中）の状態であることが保証される。

### デメリット
- 特になし（運用ルールがシンプルになる）。

## 実装状況 / Implementation Status
- 同期ロジック（新規・更新の分岐）の実装: 未着手
