# 概要 / Summary
[ADR-004] タイトル: 承認プロセスにおけるドキュメント内容の自動転記と Issue の Upsert 化

- **Status**: 提案中
- **Date**: 2026-01-01

## 状況 / Context
現在の Issue Creator Kit (ICK) は、ドキュメントが承認される（`_inbox` から `_approved` へ移動する）際に GitHub Issue を作成するが、その内容はタイトルのみであり、本文は空の状態である。
ADR や Design Doc の詳細は Git 上のファイルを確認する必要があり、GitHub の Issue ベースで作業を進める開発者にとって、情報が断絶している課題がある。
また、承認後にドキュメントを微修正した場合、既に作成済みの Issue を手動で更新しなければならず、手間とミスの原因となっている。

## 決定 / Decision
ドキュメントの承認（マージ）をトリガーに、ドキュメントの最新コンテンツを GitHub Issue の本文へ自動転記する機能を実装する。また、既存の Issue がある場合は新規作成ではなく内容の更新（Upsert）を行う。

### 1. コンテンツの自動転記
- **処理**: `ApprovalUseCase` がドキュメントを処理する際、Markdown の本文（メタデータブロックを除く）を抽出し、GitHub Issue の `body` に設定する。
- **目的**: GitHub 上の Issue 画面だけで設計内容の全容を把握可能にする。

### 2. Issue の Upsert 化
- **ロジック**: 
    - ドキュメント内に `Issue: #XXX` という記述があるかを確認。
    - **存在する場合**: その番号の Issue を `update_issue` API で更新する。
    - **存在しない場合**: `create_issue` API で新規作成し、採番された番号をドキュメントに追記する。
- **目的**: 承認プロセスが再実行された場合や、承認済みドキュメントの修正マージ時に、既存の Issue を最新状態に保つ。

### 3. 実行タイミング
- `reqs/design/_inbox/**` または `reqs/design/_approved/**` へのプッシュ（マージ）をトリガーとする。
- これにより、「新規承認」だけでなく「承認済みドキュメントの更新」のタイミングでも Issue が自動的に最新化される。

## 検討した代替案 / Alternatives Considered
- **案A: 常に Issue 作成のみを行い、更新は行わない**
    - 初回の転記はできるが、その後の修正が反映されないため、本 ADR の目的（利便性向上）を半分しか達成できない。
- **案B: 外部の同期ツールを導入する**
    - 本システム（ICK）の「ファイルベースの自動化」というコンセプトを維持するため、内部機能として実装するのが適切。

## 結果 / Consequences

### 4大リスク評価結果
- **[価値: 高]**: 開発者は GitHub Issue を見るだけで設計の最新状態を把握でき、ドキュメントとの往復を減らせる。
- **[実現可能性: 高]**: `GitHubAdapter` への `update_issue` 追加と、Markdown 解析ロジックの小規模な拡張で実現可能。
- **[ユーザビリティ: 高]**: ユーザーは従来通り Markdown を修正してマージするだけでよく、追加の操作は不要。
- **[ビジネス生存性: 高]**: 設計情報が GitHub の検索インデックスに含まれるようになり、プロジェクトの透明性が向上する。

### メリット (Positive consequences)
- 設計情報のアクセシビリティが劇的に向上する。
- 同一ドキュメントに対して複数の Issue が重複して作られるリスクを排除できる。

### デメリット (Negative consequences)
- 大規模な ADR の場合、GitHub Issue の本文制限（約65,536文字）に抵触する可能性があるが、通常の設計ドキュメントであれば十分収まる範囲。

## 検証基準 / Verification Criteria
- ドキュメントが承認され `_approved` に移動した際、GitHub Issue が作成され、ドキュメントの本文が転記されていること。
- `_approved` 内のドキュメントを修正してマージした際、対応する既存 Issue の本文が最新化されること。

## 実装状況 / Implementation Status
未着手
