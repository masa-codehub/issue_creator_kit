# スキル: ADR作成 (Architecture Decision)

**技術選定、パターン採用、および技術的負債の抜本的な解消など、長期的影響が大きい決定を行うための標準プロセスです。** ユーザーの曖昧な指示や現状の「痛み」を「検証可能な仮説」へと昇華させ、SSOT を構築します。

このドキュメントは、SYSTEM_ARCHITECT が `~/.gemini/GEMINI.md` の「プロジェクト進行フレームワーク（State Machine）」を実行する際に参照するデータソースです。

---

## 1. Planning Phase Inputs (for State 1)

計画策定時に、以下の情報を「能動的偵察 (Active Reconnaissance)」によって収集し、Todoリストの具体化に利用してください。

### 1.1 能動的偵察 (Active Reconnaissance)
*   **既存決定の確認:** `ls reqs/design/_inbox/ reqs/design/_approved/` で採番を確認し、`read_file` で関連する既存ADRを読み込む。
*   **コンテキストの把握:** `read_file("docs/system-context.md")` でシステム境界を再確認する。
*   **現場の証拠収集:**
    *   リファクタリングや技術選定の動機となるコードを `search_file_content` で特定する。
    *   *Goal:* 「なんとなく」ではなく、「`src/legacy/auth.py` の複雑度が限界だから」といった具体的なファクトを動機にする。

### 1.2 作業ブランチの計画
*   **Action:** `~/.gemini/GEMINI.md` の **「1. Gitによるバージョン管理」** に従い、作業用ブランチを作成するタスクをTodoの先頭に追加する。

### 1.3 リスク評価 (Specific Context)
`~/.gemini/GEMINI.md` の **「3. プロジェクト進行 > 3. リスク評価」** を参照し、特に以下の観点を追加で考慮する。
*   **不可逆性:** この決定は後から簡単に覆せるか？（不可逆ならより慎重な合意が必要）
*   **影響範囲:** どのコンテキストに波及するか？

### 1.4 観察結果の統合とドラフト出力 (Observe & Draft)
*   調査結果とリスク評価を統合し、現状（Context）を整理する。
*   `~/.gemini/GEMINI.md` の **「2. ファイル操作」** に従い、`reqs/design/_inbox/adr-XXX-title.md` を新規作成する。
    *   **Rule:** ステータスは `提案中` とし、日付を本日（YYYY-MM-DD）に設定、「状況 (Context)」セクションのみを詳細に記述すること。

---

## 2. Execution Phase Actions (for State 2)

Todoを実行する際、以下の思考プロセスと記述ガードレールを遵守してください。

### 2.1 ドメインモデルに基づく分析 (Hypothesis - Step 1: Modeling)
いきなり設計を書かず、まずドメインの観点で要求を構造化します。

*   **ドメインの境界画定 (Eric Evans の原則):** 以下のテンプレートを用いて分析を行う。
*   **ユビキタス言語の遵守:** **ここで定義した「ユビキタス言語」は、以降の全ての記述で一貫して使用すること。**

**ドメインモデリング・テンプレート**
```
【境界づけられたコンテキスト】 影響を受ける範囲（例: 決済、配送、認証など）
【主要な集約 (Aggregate)】 変更の最小単位となるデータのまとまり
【ユビキタス言語の更新】 今回の設計で導入・再定義されるべき重要なキーワード
【ドメイン層の責務】 この機能が解決すべき「ビジネスロジック」の核心
```

### 2.2 SSOT精査と概念的整合性の検証 (Integrity - Step 2: Scrutiny)
`~/.gemini/GEMINI.md` の **「2. SSOT精査と整合性検証プロトコル」** を実行し、Step 2.1 で作成したモデルの妥当性を証明します。

1.  **Fresh Read:** `system-context.md` や関連 ADR を再読。
2.  **概念的整合性の精査 (Scrutiny):** モデルが既存の設計思想と矛盾していないか比較検証する。
3.  **考察の出力 (Synthesis):** 精査結果に基づき、モデルの正当性を論理的に説明する。

### 2.3 アーキテクチャ仮説の明文化 (Hypothesis - Step 3: Synthesis)
精査されたモデルを「検証可能な仮説」として言語化します。

**アーキテクチャ仮説テンプレート**
```
【ビジネス上の意図】 ユーザーが真に達成したいアウトカム（推測含む）
【技術的な方向性】 選択肢の核となる設計思想や技術スタック
【期待される効果】 4 大リスクの観点から見たメリット
【主要な制約】 無視できない技術的負債やプラットフォームの制約
【反証の想定】 この設計が誤りであった場合、どのような問題が顕在化するか
```

**アウトプット例 (## 決定 / Decision セクション):**
- `[AI Agent]: 承認された設計を解析し、相対パス（Depends-On: ./issue-XXX.md）を用いた Draft Issue を作成・配置する責任を持つ。`
- `[issue-kit (src/)]: Python の graphlib による順序制御と、実Issue番号への「動的置換」ロジックを実装する。`

### 2.4 戦略の発散とトレードオフ分析 (Analysis)
有力案を批判的に検証するため、以下の手順で比較分析を行います。

1.  **代替案 (Alternatives) の立案:** 有力案（案 A）に対し、相反するトレードオフを持つ代替案（案 B）を立案する。
2.  **優先評価軸による多角分析:** 以下の設計原則・バリューから、**特に重要な 3 つの評価軸**を選択し、各案を比較分析する。
    *   設計原則: Robert C. Martin (依存性), Mark Richards (特性), Martin Kleppmann (データ), Martin Fowler (進化性), Eric Evans (ドメイン)
    *   バリュー: 全体最適 (Global Optimization), アウトカム適合性
3.  **比較表の出力と ADR ファイルの更新:** `~/.gemini/GEMINI.md` の **「2. ファイル操作」** に従い、ADR の `## 検討した代替案` セクションに比較結果と推奨・非推奨の具体的な理由を書き込む。

**アーキテクチャ比較テンプレート**
```markdown
| 比較項目 | 案A (仮説) | 案B (代替案) |
| :--- | :--- | :--- |
| **設計の核心** | (設計思想) | (設計思想) |
| **4 大リスク評価** | (価値/実現/UI/生存) | (価値/実現/UI/生存) |
| **主要なトレードオフ** | (得られるもの / 捨てるもの) | (得られるもの / 捨てるもの) |
| **推奨理由** | (一貫性と整合性の観点から) | (比較対象としての意義) |
```

### 2.5 対話に向けた論点の抽出 (Preparation for Decide)
分析の結果判明したトレードオフ（分岐点）を特定し、`~/.gemini/GEMINI.md` の **「3. プロジェクト進行 > ステータス管理テンプレート」** に従って論点リストを作成し、`save_memory` に記録します。

*   **論点Todoの記述例:**
    ```markdown
    [ADR-XXX] 対話論点Todo:
    [ ] 1. 永続化方針の選択: パフォーマンス優先のNoSQLか、整合性優先のRDBか
    [ ] 2. 外部APIのタイムアウト値: 偵察で見つけた既存設定（5秒）を維持するか短縮するか
    ```

### 2.6 合意形成ループ (Decide)
論点リストに基づき、以下のループで収束させます。

1.  **合意形成ループの実行:**
    - **A. 最小単位の問いかけ:**
      - **TODO の呼び出し:** `save_memory` から優先度の高い項目を選択し、背景（リスクと副作用）を説明した上で問いかける。
    - **B. ADR の同期と提示:**
      - `~/.gemini/GEMINI.md` の **「2. ファイル操作」** に従い、`replace` で安全に更新し、変更内容を明示する。
    - **C. リストの更新:** `~/.gemini/GEMINI.md` のステータス管理テンプレートに従い、解決した論点を消し込む (`[x]`)。
    - **D. 健全な疑念と一貫性の監視:**
      - **意図の再確認:** ユーザーの反応が薄い場合、副作用を再強調して「本当にこの決定で良いか」を問いかけ、真の意図を掘り下げる。
      - **矛盾の検知:** 最新の回答が、過去の合意、SSOT、または直前の回答と矛盾していないか常に監視する。
      - **警告:** 矛盾を検知した場合は「設計の一貫性が損なわれるリスク」を説明し、再確認を行う。解消されない場合は「根本的理解の不一致」として Step 1.1 への回帰を検討する。

2.  **根本的理解の不一致への対応:**
    - 躊躇なく Step 1.1（観察・調査）に立ち戻り、メモリを破棄してやり直す。

3.  **ループの終了（完了判定）:**
    - 全ての論点が `[x]` となり、内容に合意が得られた時点で、ADR の `Status` を `承認済み` に更新する。

---

## 3. Closing Phase Criteria (for State 3)

タスク完了時に、以下の手順で最終監査を行い、品質を保証してください。

### 3.1 最終監査 (Final Audit)
以下の手順で成果物を精査し、自信を持って「Yes」と回答できるか確認します。

1.  **成果物の再読:** `read_file` を用いて、完成した ADR を読み込む。
2.  **整合性の再検証:** `~/.gemini/GEMINI.md` の「SSOT精査プロトコル」に基づき、`docs/system-context.md` や関連 ADR との矛盾がないか、ユビキタス言語が統一されているかを最終確認する。
3.  **チェックリストの消込:**
    *   **[DDD]** 境界づけられたコンテキストが明確で、ユビキタス言語が一貫しているか？
    *   **[Clean Architecture]** 依存性のルール（Robert C. Martin）が守られ、ビジネスロジックが保護されているか？
    *   **[特性/データ]** アーキテクチャ特性（Mark Richards）とデータ信頼性（Martin Kleppmann）のトレードオフが許容範囲内か？
    *   **[進化性]** 将来の変更（Martin Fowler）に対する拡張性が考慮されているか？
    *   **[4 大リスク]** 価値、実現可能性、ユーザビリティ、ビジネス生存性が担保されているか？
    *   **[全体最適]** システム全体の整合性を損なわず、ボトルネックを解消できているか？
    *   **[検証基準]** 実装の完了を客観的に判断できる「検証基準」が合意されているか？
    *   **[SSOT]** 背景（なぜ）と結果（どうなる）が、後続のエージェントに迷いなく伝わる記述になっているか？

### 3.2 成果物の定着
`~/.gemini/GEMINI.md` の **「プルリクエストの管理 (PR Protocol)」** に従い、提出してください。
*   **PR Body:** 決定事項だけでなく、「なぜ他の案を捨てたのか（代替案の棄却理由）」を明記する。