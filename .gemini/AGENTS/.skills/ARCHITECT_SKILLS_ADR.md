
技術選定、パターン採用、および**技術的負債の抜本的な解消**など、長期的影響が大きい決定を行うための標準プロセスです。ユーザーの曖昧な指示や現状の「痛み」を「検証可能な仮説」へと昇華させ、SSOT を構築します。

### Step 0: 事前調査と採番

1.  **既存番号の確認:** `run_shell_command(command="ls reqs/design/_inbox/ reqs/design/_approved/")` を実行し、既存の ADR 番号を確認して、次の連番（`XXX`）を決定する。
2.  **作業ブランチの作成:** 決定した番号を用い、`run_shell_command(command="git checkout -b feature/adr-XXX-title")` を実行してブランチを作成する。

### Step 1: コンテキストの観察とテンプレートの準備 (Observe)

1.  **テンプレートとシステムコンテキストの取得:**
    1.  `read_file(file_path="reqs/design/template/adr.md")` を実行し、最新の ADR 構造を確実に把握する。
    2.  `read_file(file_path="docs/system-context.md")` を実行し、システムの全体像と境界を再確認する。
2.  **既存資産のピンポイント調査:**
    1.  `glob(pattern="docs/**/*.md")` で関連ドキュメントを特定し、内容を読み込む。
    2.  ユーザーの要求や**リファクタリングの動機**に含まれるキーワードに基づき、`search_file_content` を用いて `src/` 内のドメイン定義や負債の核心となるロジックを特定する。
3.  **4 大リスクの初期評価:** 依頼内容に対し、以下のテンプレートを思考プロセスの冒頭に出力し、各項目を評価する。

**4 大リスク評価結果**

```
[価値: 評価(高/中/低)] 懸念理由とその詳細
[実現可能性: 評価(高/中/低)] 懸念理由とその詳細
[ユーザビリティ: 評価(高/中/低)] 懸念理由とその詳細
[ビジネス生存性: 評価(高/中/低)] 懸念理由とその詳細
```

- **価値 (Value):** 真のビジネス価値や開発速度向上に繋がるか？
- **実現可能性 (Feasibility):** 現状の技術・時間・予算で実現可能か？
- **ユーザビリティ (Usability):** 開発者にとって理解しやすく拡張しやすいか？
- **ビジネス生存性 (Viability):** 法務・セキュリティ・リグレッションリスク等の観点で問題ないか？

4.  **観察結果の統合とドラフト出力:**
    1.  調査結果とリスク評価を統合し、ユーザーの曖昧な指示や**既存コードの「真の課題」**、主要な制約条件を整理する。
    2.  `write_file` を用いて、`reqs/design/_inbox/adr-XXX-title.md` を新規作成する。この際、**ステータスは `提案中` とし、日付を本日（YYYY-MM-DD）に設定、「状況 (Context)」セクションのみを詳細に記述すること。**

### Step 2: ドメインモデルに基づく仮説構築 (Orient - 1)

1.  **ドメインの境界画定 (Eric Evans の原則):**
    - ユーザーの要求を、以下の **「ドメインモデリング・テンプレート」** に従って分析する。**ここで定義した「ユビキタス言語」は、以降の全ての記述で一貫して使用すること。**

**ドメインモデリング・テンプレート**

```
【境界づけられたコンテキスト】 影響を受ける範囲（例: 決済、配送、認証など）
【主要な集約 (Aggregate)】 変更の最小単位となるデータのまとまり
【ユビキタス言語の更新】 今回の設計で導入・再定義されるべき重要なキーワード
【ドメイン層の責務】 この機能が解決すべき「ビジネスロジック」の核心
```

2.  **概念的整合性の検証:**

    1.  **最上位コンテキストの再読:** `read_file(file_path="docs/system-context.md")` を実行し、境界と外部インターフェースを再確認する。
    2.  **関連決定事項の精査:** `read_file` を用いて、関連する既存 ADR を読み込む。
    3.  **整合性チェックの実行:** 今回の仮説が「原則・用語・責務・技術」の 4 観点で既存の設計思想と矛盾していないか比較検証する。

3.  **仮説の言語化と反証の検討:**
    - 設計の方向性を以下の **「アーキテクチャ仮説テンプレート」** に従って整理する。

**アーキテクチャ仮説テンプレート**

```
【ビジネス上の意図】 ユーザーが真に達成したいアウトカム（推測含む）
【技術的な方向性】 選択肢の核となる設計思想や技術スタック
【期待される効果】 4 大リスクの観点から見たメリット
【主要な制約】 無視できない技術的負債やプラットフォームの制約
【反証の想定】 この設計が誤りであった場合、どのような問題が顕在化するか
```

4.  **ドラフトへの反映:**
    - `replace` を用い、`reqs/design/_inbox/adr-XXX-title.md` の `## 決定 / Decision` セクションの直後に、現時点での有力な仮説を記述する。
    - **記述ルール:** 確定事項のように書かず、「仮説案」として記述し、未確定な要素には `[要検討: XX]` というタグを付与して、ユーザーへの問いかけ（Step 4）の準備を整える。

### Step 3: 戦略の発散とトレードオフ分析 (Orient - 2)

1.  **代替案 (Alternatives) の立案:**

    - Step 2 の有力案（案 A）に対し、相反するトレードオフを持つ代替案（案 B）を少なくとも 1 つ立案する。

2.  **優先評価軸による多角分析:**

    - 以下の設計原則・バリューから、今回の決定において**特に重要な 3 つの評価軸**を選択し、各案を比較分析する。
      - **設計原則:** Robert C. Martin (依存性), Mark Richards (特性), Martin Kleppmann (データ信頼性), Martin Fowler (進化性), Eric Evans (ドメイン整合性)
      - **バリュー:** 全体最適 (Global Optimization), アウトカム適合性

3.  **比較表の出力と ADR ファイルの更新:**
    1.  以下の **「アーキテクチャ比較テンプレート」** を用いて整理し、思考プロセスとして出力する。
    2.  `replace` ツールを使用し、`reqs/design/_inbox/adr-XXX-title.md` の `## 検討した代替案 / Alternatives Considered` セクションに、この比較表と推奨・非推奨の理由を具体的に書き込む。

**アーキテクチャ比較テンプレート**

```
| **比較項目 | 案A (仮説) | 案B (代替案) |
| :--- | :--- | :--- |
| **設計の核心** | (設計思想) | (設計思想) |
| **4 大リスク評価** | (価値/実現/UI/生存) | (価値/実現/UI/生存) |
| **主要なトレードオフ** | (得られるもの / 捨てるもの) | (得られるもの / 捨てるもの) |
| **推奨理由** | (一貫性と整合性の観点から) | (比較対象としての意義) |
```

**アウトプット例 (記述レベル感):**
- **## 決定 / Decision (責務と技術的仕様の統合):**
    - `[AI Agent]: 承認された設計を解析し、相対パス（Depends-On: ./issue-XXX.md）を用いた Draft Issue を作成・配置する責任を持つ。`
    - `[issue-kit (src/)]: Python の graphlib による順序制御と、GitHub API から取得した実Issue番号への「動的置換」ロジックを実装する。`
    - `[GitHub Actions]: main マージをトリガーに issue-kit run を実行し、認証トークンの供給と実行環境の提供を担う。`

4.  **対話に向けた論点の抽出:**
    - 分析の結果判明した「最も大きなトレードオフ（ユーザーに判断を仰ぐべき分岐点）」を 2〜3 個特定し、Step 4 で使用する質問案を準備する。

### Step 4: ユーザーとの対話による発散と収束 (Decide)

ユーザーとの対話を通じて ADR を動的に完成させるステップです。全ての論点が解消されるまで、以下の **「合意形成ループ」** を回し続けます。

1.  **論点（質問リスト）の初期化:**

    - Step 3 の分析結果に基づき、解消すべき論点やトレードオフを特定する。
    - `save_memory` を用いて、解決すべき項目を記録する。
    - **記述の具体性:** 単なる単語ではなく、後で思考を再現できるよう「なぜこれを聞く必要があるのか」「どのようなリスクを懸念しているのか」という背景と具体的な質問案を併記すること。
    - **コマンド例:** `save_memory(fact="[ADR-XXX] 論点TODO: 1.データ整合性の方針(リトライ時の重複排除をどう担保するか要確認)...")`

2.  **合意形成ループの実行:**

    - **A. 最小単位の問いかけ:**
      - **TODO の呼び出し:** `save_memory` に記録した論点 TODO を確認し、現在の状況に照らして最も優先度の高い項目を一つ選択する。
      - **バリューに基づく問いかけ:** 「この設計は当初のアウトカム（成果）を達成できるか？」「4 大リスクへの影響はどうか？」という視点を交え、リスクと副作用を具体的に説明した上でユーザーに問いかける。
    - **B. ADR の同期と提示:**
      - ユーザーの回答に基づき、`reqs/design/_inbox/adr-XXX-title.md` の該当セクションを `replace` で即座に更新する。
      - **置換のコツ:** ツール失敗を避けるため、`old_string` には十分なコンテキスト（3 行以上の前後行）を含めること。
      - **更新の明示:** ユーザーに対し、ADR のどの箇所をどのように書き換えたのか（Before/After または要約）をチャット上で明示し、確認を促す。
    - **C. リストの更新:** 解決した論点を TODO リストから削除（消込）し、新たに判明した疑問があればリストに追加して `save_memory` を更新する。
    - **D. 健全な疑念と一貫性の監視:**
      - ユーザーの反応が薄い場合、副作用を再強調して意図を再確認する。
      - **矛盾の検知:** ユーザーの最新の回答が、過去の合意事項や直前の回答と矛盾していないか常に監視する。矛盾を検知した場合は「根本的な理解の不一致」の兆候として捉え、Step 3 への立ち戻りや Step 1 への回帰を強く検討する。

3.  **根本的理解の不一致への対応:**

    - 対話の中で「前提が間違っている」と判明した場合は、**ループを中断し、躊躇なく Step 1（観察・調査）に立ち戻り、仮説からやり直す。**
    - **メモリの破棄:** 立ち戻る際、`save_memory(fact="[ADR-XXX] 論点TODO: (廃棄済み・再構築中)")` を実行し、古い TODO を無効化すること。

4.  **ループの終了（完了）:**
    - `save_memory` 内の全ての論点が解消され、最新の ADR の内容および **「検証基準 (Verification Criteria)」** に対してユーザーと合意・確信を共有できた時点で、このフェーズを完了とする。
    - **ステータスの更新:** `replace` を用い、ADR の `Status` を `提案中` から `承認済み` に、`Date` を合意した日付に変更する。
    - **メモリのクリーンアップ:** 完了にあたり、`save_memory(fact="[ADR-XXX] 論点TODO: (全て解消・完了)")` を実行し、メモリ上の作業リストを整理する。

### Step 5: SSOT の構築と伝達 (Act)

1.  **最終監査 (Final Audit):**

    1.  **成果物の再読:** `read_file` を用いて、完成した `reqs/design/_inbox/adr-XXX-title.md` を読み込む。
    2.  **整合性の再検証:** `docs/system-context.md` や関連 ADR を再度読み込み、最新の決定事項がシステム全体と矛盾していないか、ユビキタス言語が厳密に統一されているかを精査する。
    3.  **チェックリストの消込:** 以下の項目に対し、自信を持って「Yes」と回答できるかを最終監査する。
        - **[DDD]** 境界づけられたコンテキストが明確で、ユビキタス言語が一貫しているか？
        - **[Clean Architecture]** 依存性のルール（Robert C. Martin）が守られ、ビジネスロジックが保護されているか？
        - **[特性/データ]** アーキテクチャ特性（Mark Richards）とデータ信頼性（Martin Kleppmann）のトレードオフが許容範囲内か？
        - **[進化性]** 将来の変更（Martin Fowler）に対する拡張性が考慮されているか？
        - **[4 大リスク]** 価値、実現可能性、ユーザビリティ、ビジネス生存性が担保されているか？
        - **[全体最適]** システム全体の整合性を損なわず、ボトルネックを解消できているか？
        - **[検証基準]** 実装の完了を客観的に判断できる「検証基準」が合意されているか？
        - **[SSOT]** 背景（なぜ）と結果（どうなる）が、後続のエージェントに迷いなく伝わる記述になっているか？

2.  **コミットと PR の起票:**
    1.  `run_shell_command(command="git add reqs/design/_inbox/adr-XXX-title.md && git commit -m 'docs: ADR-XXX (タイトル) を承認済みとして作成'")` を実行し、成果物をステージング・コミットする。
    2.  `create_pull_request` を実行し、以下の構成で PR を起票する。
        - **Title:** `docs(adr): ADR00x (タイトル) の作成`
        - **Body:** `## 概要\n(決定事項の要約)\n\n## 背景\n(なぜこの決定が必要だったか)\n\n## 影響範囲\n(実装担当が注意すべき点)`
    3.  **完了定義:** PR が起票され、設計思想が公式な記録として提出された時点で、アーキテクトとしての本ユースケースを完了とする。
