
システムの全体像（システムの境界、外部システム、ユーザー、主要なデータフロー）を定義し、常に最新の状態に保つための最優先プロセスです。すべての設計決定（ADR/Design Doc）の「北極星」となります。

### Step 0: 事前準備

1.  **作業ブランチの作成:** `run_shell_command(command="git checkout -b feature/arch-system-context")` を実行し、安全な作業環境を確保する。
2.  **ディレクトリの準備:** `run_shell_command(command="mkdir -p docs/architecture/")` を実行する。

### Step 1: コンテキストの観察と情報収集 (Observe)

1.  **既存資産の棚卸しと「行間」の読解:**
    - `read_file(file_path="docs/system-context.md")` 等で既存定義を確認する。
    - **顧客価値の探求:** 提示された要求の背後にある「ユーザー自身も気づいていない潜在的な課題」や「真に達成したいアウトカム」を推論し、思考プロセスとして出力する。
2.  **4 大リスクの初期評価:** プロジェクト開始時、または大規模変更時に、以下のテンプレートを思考プロセスの冒頭に出力して評価する。

**システムコンテキスト 4 大リスク評価**
```
[価値: 評価(高/中/低)] システムの解決すべき課題とアウトカムは明確か？
[実現可能性: 評価(高/中/低)] 外部システムやインフラの制約内で実現可能か？
[ユーザビリティ: 評価(高/中/低)] システムの境界（責務）は開発者にとって直感的か？
[ビジネス生存性: 評価(高/中/低)] 法務・セキュリティ・サードパーティ依存に致命的リスクはないか？
```

### Step 2: システム境界とアクターの定義と記録 (Orient - 1)

1.  **テンプレートの取得:** `read_file(file_path="docs/template/system-context.md")` を実行し、SSOT の構成を把握する。
2.  **情報の定義と一括記録 (Write):** 読み込んだテンプレートの Markdown 構造をベースに、以下の定義内容を各セクションに埋め込み、`write_file(file_path="docs/system-context.md", content="...")` で一括記録する。**ステータスは `作成中` とする。**
    - **全体最適:** システム境界を定義する際、依存関係における「技術的・組織的なボトルネック（例: 外部APIの低速なレスポンス、手動運用の介在等）」を特定し、境界設計に反映させる。
    - **境界の画定:** 「## 3. システムの境界と責務」に定義。
    - **アクターと外部システムの特定:** 「## 4. アクターと外部システム」に役割とリスクを定義。

**アウトプット例 (記述レベル感):**
- **## 1. ビジネスコンテキストとアウトカム:**
    - `工場管理者が重機ごとの「サイクル電力（1工程あたりの消費電力）」をリアルタイムに把握し、非効率な稼働パターンを特定することで、年間電力コストの15%削減を支援する。`
- **## 2. 主要なユビキタス言語:**
    - `| サイクル電力 | 1台の重機が1工程（掘削、旋回、放土）を完了するのに要した総電力。効率分析の基本単位。 |`
- **## 3. システムの境界と責務:**
    - `【サイクル解析】 本システム / センサーデータから「工程の区切り」を推論するロジックは、本プロジェクトの競争力の核であるため内部に保持。`
    - `【ボトルネックの最適化】 既存の「手動日報入力」がデータ鮮度の最大の壁となっているため、本システムで自動収集を行うことで意思決定の遅延を解消する。`
- **## 4. アクターと外部システム:**
    - `[工場管理者]: 現場の意思決定者。異常値発見から5秒以内にドリルダウンできるユーザビリティが、運用の生存性に直結。`
    - `[Stripe API]: サブスクリプション決済。APIの可用性がビジネス継続性の最大リスク。`

### Step 3: データフローのモデル化と視覚化 (Orient - 2)

1.  **ドラフトの洗練 (Update):** 以下の見本を参考に、`replace` を用いて詳細情報を追記・洗練させる。

**アウトプット例 (記述レベル感):**
- **## 6. 戦略的トレードオフと 4 大リスク:**
    - `[鮮度 vs 正確性]: 電力コストの請求根拠となるため正確性を最優先する。ネットワーク遅延による10秒程度の表示遅延は許容し、重複排除（Exactly-once）を保証する。`
- **## 7. 設計原則とデータ信頼性:**
    - `[不変データモデル]: 過去の電力消費推移を正確に再現するため、すべてのデータは「上書き」せず、タイムスタンプ付きの不変（Immutable）なイベントとして記録する。`
    - `[ドメインの純粋性]: サイクル解析ロジックは外部Framework（FastAPI等）に依存させず、PlainなPythonで記述することで、将来のインフラ変更に対する進化性を確保する。`

### Step 4: ユーザーとの合意形成ループ (Decide)

ユーザーとの対話を通じて、システム境界や主要な依存関係を確定させるステップです。全ての論点が解消されるまで、以下の **「合意形成ループ」** を回し続けます。

1.  **論点（質問リスト）の初期化:**
    - Step 3 までの定義結果に基づき、解消すべき不確定要素（例: 「決済ロジックのどこまでを本システムで行うか」等）を特定する。
    - `save_memory` を用いて、解決すべき項目を記録する。
    - **コマンド例:** `save_memory(fact="[System-Context] 論点TODO: 1.在庫計算の外部API依存範囲の確定(リトライポリシー含む)...")`

2.  **合意形成ループの実行:**
    - **A. 最小単位の問いかけ:**
        - **TODO の呼び出し:** `save_memory` から優先度の高い項目を選択し、背景（リスクとアウトカム）を説明した上でユーザーに問いかける。
    - **B. SSOT の同期と提示:**
        - ユーザーの回答に基づき、`docs/system-context.md` の該当セクションを `replace` で即座に更新する。
        - **更新の明示:** どの境界や原則が、どのように確定・変更されたのかを要約してユーザーに提示する。
    - **C. リストの更新:** 解決した論点を削除し、新たな疑問があれば `save_memory` に追加する。
    - **D. 健全な疑念と不整合の監視:**
        - **不整合の検知:** ユーザーの回答が、既存のビジネス制約や 4 大リスクの評価と矛盾していないか常に監視する。
        - **警告:** 矛盾を検知した場合は「この境界定義は、将来的に XX という生存性リスクを招く可能性があります」と具体的に警告し、再確認を行う。

3.  **根本的理解の不一致への対応:**
    - 対話の中で「システムの存在意義や主要なアクターが想定と全く異なる」ことが判明した場合は、**躊躇なく Step 1（情報収集・リスク評価）に立ち戻り、コンセプトを再定義する。**
    - 古い TODO は `save_memory` から破棄し、新しい前提でリストを再構築する。

4.  **ループの終了（完了判定）:**
    - `save_memory` 内の全ての論点が解消され、システムの「守備範囲」と「戦略的選択」に対してユーザーと確固たる合意が得られた時点で、このフェーズを完了とする。
    - **ステータスの更新:** `replace` を用い、システムコンテキストの `Status` を `作成中` から `承認済み` に更新する。

### Step 5: SSOT の確立と伝達 (Act)

1.  **最終監査 (Final Audit):**
    1.  **成果物の再読:** `read_file` を用いて、完成した `docs/system-context.md` を読み込む。
    2.  **概念的整合性の精査:** 記述された境界、原則、言語が、プロジェクトの当初の目的（アウトカム）と矛盾しておらず、かつ実現可能なレベルまで具体化されているかを最終確認する。
    3.  **チェックリストの消込:** 以下の項目に対し、自信を持って「Yes」と回答できるかを最終監査する。
        - **[アウトカム志向]** このシステムが解決すべき「真の課題」と、もたらすべき「良い変化」が明確に記述されているか？
        - **[境界の明解さ]** 責務の所在（本システム/外部）がユビキタス言語で定義され、重複や漏れがないか？
        - **[4 大リスクの克服]** 生存性や実現可能性上の最大のリスクに対する、アーキテクチャレベルの回答（トレードオフ）が記録されているか？
        - **[設計原則の強度]** Martin Kleppmann のデータ信頼性や Clean Architecture の原則が、具体的な方針として明文化されているか？
        - **[地図としての役割]** 後続の ADR や Design Doc を作成する際、このドキュメントが「迷いのない判断基準」として機能するか？

2.  **コミットと PR の起票:**
    1.  **ステージングとコミット:** `run_shell_command(command="git add docs/system-context.md && git commit -m 'docs: システムコンテキストを承認済みとして作成/更新'")` を実行する。
    2.  **PR の起票:** `create_pull_request` を実行し、以下の構成で PR を起票する。
        - **Title:** `docs(arch): システムコンテキスト (SSOT) の作成/更新`
        - **Body:**
          ```markdown
          ## 概要
          プロジェクトの全体像と境界を定義するシステムコンテキスト (SSOT) を作成しました。

          ## 主な決定事項
          - システム境界の画定 (In-Scope / Out-of-Scope)
          - 主要なトレードオフ (例: 正確性 vs 鮮度)
          - 守るべき設計原則 (Clean Architecture等)

          ## 実装・設計への影響
          今後作成されるすべての ADR および Design Doc は、本ドキュメントの定義に従います。
          ```
    3.  **完了定義:** PR が起票され、プロジェクトの「北極星」が公式な記録として提出された時点で、本ユースケースを完了とする。
