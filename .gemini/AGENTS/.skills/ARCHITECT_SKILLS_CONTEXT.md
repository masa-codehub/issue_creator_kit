# スキル: システムコンテキスト管理 (Architect Context)

このドキュメントは、SYSTEM_ARCHITECT が `~/.gemini/GEMINI.md` の「プロジェクト進行フレームワーク（State Machine）」を実行する際に、具体的なアクションとアウトプットの品質を担保するためのデータソースです。

---

## 1. Planning Phase Inputs (for State 1)

計画策定時に、以下の情報を「偵察 (Reconnaissance)」によって収集し、Todoリストの具体化に利用してください。

### 1.1 能動的偵察 (Active Reconnaissance)
*   **既存資産の棚卸しと「行間」の読解:** `read_file(file_path="docs/system-context.md")` 等で既存定義を確認し、現在の設計思想や未解決の課題を読み取る。
*   **構造の地図化:** `glob(pattern="**/*")` を実行し、主要ディレクトリ（`src`, `infra`, `docs`等）から全体像を把握する。
*   **外部依存の特定:** `search_file_content(pattern="import|http://")` で外部システムとの接続点を洗い出す。
*   **顧客価値の探求:** 提示された要求の背後にある「ユーザー自身も気づいていない潜在的な課題」や「真に達成したいアウトカム」を推論する。

### 1.2 4 大リスクの初期評価
以下のテンプレートを Todo のセルフレビュー時に使用し、現在の理解度を測定してください。

**システムコンテキスト 4 大リスク評価テンプレート**
```
[価値: 評価(高/中/低)] システムの解決すべき課題とアウトカムは明確か？
[実現可能性: 評価(高/中/低)] 外部システムやインフラの制約内で実現可能か？
[ユーザビリティ: 評価(高/中/低)] システムの境界（責務）は開発者にとって直感的か？
[ビジネス生存性: 評価(高/中/低)] 法務・セキュリティ・サードパーティ依存に致命的リスクはないか？
```

---

## 2. Execution Phase Actions (for State 2)

Todoを実行する際、以下のアクションパターンと具体的な記述レベルを遵守してください。

### 2.1 境界と用語の画定 (Define & Record)
`read_file(file_path="docs/template/system-context.md")` をベースに、偵察で得た「証拠（Evidence）」に基づいて記述します。記述後は `write_file` で一括保存します。**初期ステータスは `作成中` とします。**

#### 記述レベルのガードレール (アウトプット例)
*   **全体最適の視点:** ボトルネック（手動運用や低速API）を特定し、境界設計に反映させてください。

- **## 1. ビジネスコンテキストとアウトカム:**
    - `工場管理者が重機ごとの「サイクル電力（1工程あたりの消費電力）」をリアルタイムに把握し、非効率な稼働パターンを特定することで、年間電力コストの15%削減を支援する。`
- **## 2. 主要なユビキタス言語:**
    - `| サイクル電力 | 1台の重機が1工程（掘削、旋回、放土）を完了するのに要した総電力。効率分析の基本単位。 |`
- **## 3. システムの境界と責務:**
    - `【サイクル解析】 本システム / センサーデータから「工程の区切り」を推論するロジックは、本プロジェクトの競争力の核であるため内部に保持。`
    - `【ボトルネックの最適化】 既存の「手動日報入力」がデータ鮮度の最大の壁となっているため、本システムで自動収集を行うことで意思決定の遅延を解消する。`
- **## 4. アクターと外部システム:**
    - `[工場管理者]: 現場の意思決定者。異常値発見から5秒以内にドリルダウンできるユーザビリティが、運用の生存性に直結。`
    - `[Stripe API]: サブスクリプション決済。APIの可用性がビジネス継続性の最大リスク。`
- **## 6. 戦略的トレードオフと 4 大リスク:**
    - `[鮮度 vs 正確性]: 電力コストの請求根拠となるため正確性を最優先する。ネットワーク遅延による10秒程度の表示遅延は許容し、重複排除（Exactly-once）を保証する。`
- **## 7. 設計原則とデータ信頼性:**
    - `[不変データモデル]: 過去の電力消費推移を正確に再現するため、すべてのデータは「上書き」せず、タイムスタンプ付きの不変（Immutable）なイベントとして記録する。`
    - `[ドメインの純粋性]: サイクル解析ロジックは外部Framework（FastAPI等）に依存させず、PlainなPythonで記述することで、将来のインフラ変更に対する進化性を確保する。`

### 2.2 合意形成ループ (Decide)
ユーザーとの対話を通じて不確定要素を解消し、システム境界を確定させます。

1.  **論点リストの初期化:**
    *   解消すべき項目を `save_memory` に記録する。
    *   **例:** `save_memory(fact="[System-Context] 論点TODO: 1.在庫計算の外部API依存範囲の確定(リトライポリシー含む)...")`
2.  **ループ実行:**
    *   **A. 最小単位の問いかけ:** 優先度の高い項目を選択し、背景（リスクとアウトカム）を説明した上で問いかける。
    *   **B. SSOT の同期:** 回答に基づき `replace` でドキュメントを即座に更新し、変更内容をユーザーに提示する。
    *   **C. 不整合の監視:** 回答が 4 大リスクを増大させる場合（例: 「S3は使わない」と言われたがコードに `boto3` がある等）は、具体的に警告し再確認する。
3.  **根本的不一致への対応:**
    *   前提が覆った場合は、躊躇なく **Step 1（情報収集）** に立ち戻り、コンセプトを再定義する。
4.  **完了判定:**
    *   全ての論点が解消された時点で、`replace` を用いステータスを `承認済み` に更新する。

---

## 3. Closing Phase Criteria (for State 3)

タスク完了時に、以下の基準で品質を検証してください。

### 3.1 最終監査 (Final Audit)
以下の手順で成果物を精査し、自信を持って「Yes」と回答できるか確認します。

1.  **成果物の再読:** `read_file` を用いて、完成した `docs/system-context.md` を読み込む。
2.  **概念的整合性の精査:** 記述された境界、原則、言語が、プロジェクトの当初の目的（アウトカム）と矛盾しておらず、かつ実現可能なレベルまで具体化されているかを最終確認する。
3.  **チェックリストの消込:**
    *   **[アウトカム志向]** このシステムが解決すべき「真の課題」と、もたらすべき「良い変化」が明確に記述されているか？
    *   **[境界の明解さ]** 責務の所在（本システム/外部）がユビキタス言語で定義され、重複や漏れがないか？
    *   **[4 大リスクの克服]** 生存性や実現可能性上の最大のリスクに対する、アーキテクチャレベルの回答（トレードオフ）が記録されているか？
    *   **[設計原則の強度]** Martin Kleppmann のデータ信頼性や Clean Architecture の原則が、具体的な方針として明文化されているか？
    *   **[地図としての役割]** 後続の ADR や Design Doc を作成する際、このドキュメントが「迷いのない判断基準」として機能するか？

### 3.2 成果物の定着
`~/.gemini/GEMINI.md` の「1. Gitによるバージョン管理」および **「プルリクエストの管理 (PR Protocol)」** に従い、成果物を提出してください。

*   **コミットメッセージ:** `docs(arch): update system context (SSOT)` を基本とする。
*   **PR内容のガードレール:**
    - **概要/目的:** 本スキルで実施した「能動的偵察」の結果と、それに基づく設計判断（境界、用語）を具体的に記述する。
    - **根拠:** どのファイルやコードを証拠（Evidence）としたかを明記する。