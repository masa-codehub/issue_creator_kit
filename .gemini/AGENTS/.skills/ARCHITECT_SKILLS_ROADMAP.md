# スキル: ロードマップ策定 (Implementation Planning)

**承認済みの ADR または Design Doc を、稼働中のシステムを壊さずに実現するための「段階的な実装・修正手順」を設計するプロセスです。** 設計ドキュメントが「目的地」を定義していることを前提に、本ユースケースはそこへ至る「安全な着地ステップ」の策定のみに責任を持ちます。

このドキュメントは、SYSTEM_ARCHITECT が `~/.gemini/GEMINI.md` の「プロジェクト進行フレームワーク（State Machine）」を実行する際に参照するデータソースです。

---

## 1. Planning Phase Inputs (for State 1)

計画策定時に、以下の情報を「能動的偵察 (Active Reconnaissance)」によって収集し、Todoリストの具体化に利用してください。

### 1.1 能動的偵察 (Active Reconnaissance)
*   **前提設計の読み込み:** `reqs/design/_approved/` から承認済み設計を読み込み、ゴールの「あるべき姿」を完全に理解する。
*   **不確実性と阻害要因の特定:**
    1.  **ドキュメント精査:** 以下の観点リストからリスクが高い項目を評価し、`glob` で関連ドキュメントを特定して再調査する。
        *   **[非機能要件]** 性能・可用性・拡張性 (SLAとの整合)
        *   **[運用・保守性]** ログ監視・障害復旧・デプロイ要件
        *   **[セキュリティ]** 認証・認可・データ保護・監査
        *   **[データ整合性]** トランザクション境界・マイグレーション・整合性モデル
        *   **[外部依存]** APIレート制限・ライブラリサポート期限
        *   **[UI/UX・用語]** デザインガイドライン・ユビキタス言語の統一
        *   **[法規制・廃止]** コンプライアンス・廃止予定機能への依存
    2.  **コードベース精査:** `search_file_content` を用い、設計の適用を阻害する既存実装や技術的懸念を網羅的にリストアップする。

**アウトプット例 (分析と選定):**
```markdown
### 阻害要因・懸念リストと対策方針
- **[高] 密結合:** `OrderService` が `StripeClient` を直接 `new()` しており、DI できない。
    - -> **対策:** Phase 1 にて `IPayment` インターフェース抽出と DI 化を Pre タスクとして実施。
- **[高] パフォーマンス:** 大量データ時の集計クエリの挙動が不明。
    - -> **対策:** Phase 1 の最初に Spike タスクを設け、1,000万件データでの負荷検証を行う。
- **[中] ライブラリ互換性:** `v2.0` が Python 3.8 で動くか未確認。
    - -> **対策:** 検証用スクリプトで動作確認を行うタスクを追加。
```

### 1.2 作業ブランチの計画
*   **Action:** `~/.gemini/GEMINI.md` の **「1. Gitによるバージョン管理」** に従い、`design/plan-XXX-feature-name` 等のブランチを作成するタスクをTodoの先頭に追加する。

### 1.3 リスク評価 (Specific Context)
`~/.gemini/GEMINI.md` の 「3. プロジェクト進行 > 3. リスク評価」を参照し、以下のテンプレートを用いてインパクトを評価してください。

**実装・リファクタリング計画 4 大リスク評価テンプレート**
```
[価値: 評価(高/中/低)] 計画の各ステップが、早期に部分的な価値（動作確認等）を提供できるか？
[実現可能性: 評価(高/中/低)] 既存のビジネスロジックを維持したまま、段階的に適用可能か？
[ユーザビリティ: 評価(高/中/低)] 実装途中の「新旧混在状態」が、開発者の混乱を招かないか？
[ビジネス生存性: 評価(高/中/低)] データ破損やダウンタイムのリスクは許容範囲か？リセット手順はあるか？
```

### 1.4 実装戦略の定義 (Observe & Draft)
*   `~/.gemini/GEMINI.md` の **「2. ファイル操作」** に従い、ドラフトを作成し、安全な着地の「戦略（型）」を記述する（ステータス: `作成中`）。
    *   **Action:** 偵察で特定した懸念への「調査タスク (Spike)」を計画の冒頭に組み込むことを検討する。

---

## 2. Execution Phase Actions (for State 2)

Todoを実行する際、以下の思考プロセスと記述ガードレールを遵守してください。

### 2.1 WBSの設計 (Structuring)
`read_file("reqs/roadmap/template/migration-roadmap.md")` をベースに、ブランチ戦略を含めた計画を策定します。

1.  **戦略とフェーズの定義:** 「Phase 1: 設計確定/Spike」→「Phase 2: 疎結合化」→「Phase 3: 新ロジック実装」→「Phase 4: 切り替え/清算」のように段階を定義する。
2.  **ブランチ戦略の定義:**
    - **Phase Base Branch (Foundation):** 各フェーズの基点（例: `feature/phase-X-foundation`）。
    - **Task Working Branch (Feature):** 各タスクの作業枝（例: `feature/task-ID-desc`）。
    - **Merge Flow:** 実装完了後は作業ブランチをベースブランチへマージし、フェーズ完了時にベースブランチを `main` へマージする流れを定義する。
3.  **WBS の展開:** 各フェーズ内に [Setup][Implementation][Review] タスクを配置し、依存関係を明示する。
    - **[先頭] Setup Task:** フェーズ用ベースブランチ（Foundation）の作成と環境準備。
    - **[中間] Implementation Tasks:** 具体的な実装・テスト・移行作業（Spike, Pre, Impl, Verify, Clean）。各タスクは固有の作業ブランチ（Feature Branch）で行われる。
    - **[末尾] Review Task:** フェーズ完了の承認（Gate チェック）と、ベースブランチの Main へのマージ。
    - **[一成果物一タスク]**: 一つのタスクには必ず一意の成果物（ドキュメント、ファイル、PR等）を紐づけ、進捗を客観的に判定可能にする。
    - **[一タスク一作業者]**: 作業の責任を明確にするため、一人の作業者が完結できる粒度に分割する。
    - **依存関係の明示:** 各タスクの「依存先 ID」および「外部チーム/APIへの依存」を特定し、クリティカルパスを明確にする。

**アウトプット例 (戦略パターン別のフェーズ定義):**
```markdown
### Phase 1: 設計とテスト要件の確定 (Design & Test Criteria)
- **Goal (狙い)**: 実装開始前に「あるべき姿」と「検証方法」を完全に一致させ、迷いと手戻りを排除する。
- **Deliverables (成果物)**: 検証基準リスト、インターフェース定義案。
    - **検証基準リスト (Acceptance Criteria)**:
        - **目的**: 正常系・異常系・境界値を含む「成功の定義」をテストレベルで言語化し、実装時の不確実性を排除するため。
    - **インターフェース定義案 (Draft Interface)**:
        - **目的**: クラス名やメソッドシグネチャを机上で確定させ、実装者間の認識を統一するため。
- **Gate (承認条件)**: 上記の定義案が、設計の意図を完全に網羅していると合意されること。

**WBS**
| Task ID | Category | タスク内容 | 対象ファイル | 依存先 | Issue案リンク |
| :---: | :---: | :--- | :--- | :---: | :--- |
| T1-1 | Setup | 作業ブランチ `feature/phase-1` の作成 | - | - | |
| T1-2 | Spike | 既存クラスの全依存関係を調査し、リスト化する | `src/legacy/service.py` | T1-1 | |

### Phase 2: 疎結合化とアダプター適用 (Decouple & Adapter)
- **Goal (狙い)**: 既存コードを壊さずに「新旧差し替え可能な状態」を作り出し、安全な移行の足場を固める。
- **Input (前提)**: 確定した検証基準とインターフェース案。
- **Deliverables (成果物)**:
    - **`Interface` / `Adapter` とそのテスト**:
        - **目的**: 既存ロジックをラップして疎結合にし、新旧ロジックを安全に切り替え可能な状態にするため。
- **Gate (承認条件)**: 既存の自動テストが Adapter 経由で全てパスし、本番デプロイしても既存機能に影響がないこと。

**WBS**
| Task ID | Category | タスク内容 | 対象ファイル | 依存先 | Issue案リンク |
| :---: | :---: | :--- | :--- | :---: | :--- |
| T2-1 | Setup | 作業ブランチ `feature/phase-2` の作成と T1 のマージ | - | T1-4 | |
| T2-2 | Impl | 旧ロジックをラップする `LegacyAdapter` の実装 | `src/new/adapter.py` | T2-1 | |

### Phase 3: 新ロジック実装と並行稼働 (Implement & Shadowing)
- **Goal (狙い)**: 新ロジックの実効性を本番データで証明し、100% の信頼を得るまで検証を回す。
- **Deliverables (成果物)**: 新ロジックの実装、並行稼働（Shadowing）の実装。
    - **新ロジックの実装とその単体テスト**:
        - **目的**: 検証基準を満たす新しいビジネスロジックを確立するため。
    - **並行稼働（Shadowing）の実装**:
        - **目的**: ユーザーに影響を与えずに、本番データを用いて新旧ロジックの出力を比較検証するため。
- **Gate (承認条件)**: 並行稼働ログにおいて新旧の出力不一致が 0 件であること。

**WBS**
| Task ID | Category | タスク内容 | 対象ファイル | 依存先 | Issue案リンク |
| :---: | :---: | :--- | :--- | :---: | :--- |
| T3-1 | Setup | 作業ブランチ `feature/phase-3` の作成と T2 のマージ | - | T2-5 | |
| T3-2 | Impl | 新ロジック `NewService` の実装 | `src/new/service.py` | T3-1 | |
| T3-3 | Impl | 新旧比較を行う `ShadowingProxy` の実装 | `src/new/proxy.py` | T3-2 | |

### Phase 4: 切り替えと負債の清算 (Release & Refactor)
- **Goal (狙い)**: 安全にバトンを渡し、古い資産を物理的に排除してシステムを健全化する。
- **Deliverables (成果物)**: 本番構成の切り替え、旧コードの削除コミット。
    - **本番構成の切り替え**:
        - **目的**: ユーザーに新ロジックの価値（性能向上等）を提供するため。
    - **旧コードの削除コミット**:
        - **目的**: 技術的負債を清算し、保守コストを下げるため。
- **Gate (承認条件)**: 旧コードが消滅し、全テストスイートがグリーンであること。

**WBS**
| Task ID | Category | タスク内容 | 対象ファイル | 依存先 | Issue案リンク |
| :---: | :---: | :--- | :--- | :---: | :--- |
| T4-1 | Setup | 作業ブランチ `feature/phase-4` の作成と T3 のマージ | - | T3-5 | |
| T4-2 | Impl | DI コンテナの設定変更（NewServiceへの切り替え） | `src/config/container.py` | T4-1 | |
| T4-4 | Clean | 旧コード `legacy/` および `LegacyAdapter` の削除 | `src/legacy/` | T4-3 | |
```

### 2.2 ロードマップのセルフレビュー (Structuring & Validation)
ロードマップのドラフトが完成したら、以下のチェックリストを用いて品質を検証します。

1.  **4 大リスクの再評価**: 策定した WBS の各ステップが、価値、実現可能性、ユーザビリティ、ビジネス生存性を損なっていないか？
2.  **ADR との整合性**: `reqs/design/_approved/` の決定事項を全てカバーしているか？
3.  **フェーズの原子性**: 各フェーズが独立したマイルストーンとして機能し、Gate（承認条件）が明確か？
4.  **依存関係の整合性**: WBS 内の Task ID と依存先 ID に循環や矛盾がないか？

### 2.3 対話に向けた論点の抽出 (Preparation for Dialogue)
ユーザーとの合意形成をスムーズにするため、計画上の「不確実性」や「トレードオフ」を論点として整理し、`save_memory` に記録します。

*   **論点抽出の観点**:
    - 工期の見積もりの妥当性（Spike タスクの範囲など）。
    - 段階的な移行中の「一時的な制約」に対する許容。
    - フェーズの切り出し方（どこで一度止めてレビューを仰ぐか）。
*   **論点Todoの記述例**: `save_memory(fact="[Roadmap-XXX] 論点TODO: 1. フェーズ分割の妥当性...")`

### 2.4 合意形成ループ (Decide)
論点リストに基づき、以下のサイクルでロードマップを「承認済み」の状態へ導きます。

1.  **最小単位の問いかけ**: `save_memory` から優先度の高い項目を選択し、背景（リスクとアウトカム）を説明した上で問いかける。
2.  **不整合の監視と警告**: 
    - ユーザーの回答が 4 大リスクを増大させる場合や、既存の ADR/SSOT と矛盾する場合は、具体的に警告（例: 「この工程を飛ばすと、ADR-001 で決めた原子性が担保できません」）し、再確認を行う。
3.  **SSOT の同期**: 回答に基づき `replace` でドキュメントを即座に更新し、変更内容を提示する。
4.  **根本的不一致への対応**: 前提や戦略が大きく覆った場合は、躊躇なく **Step 1（偵察・調査）** に立ち戻り、工程を再設計する。
5.  **完了判定**: 全ての論点が解消された時点で、Status を `承認済み` に更新し、ロードマップを `active/` へ移動する。**この移動が完了するまで、具体的な Issue 案の作成に着手してはならない。**

---

## 3. Closing Phase Criteria (for State 3)

タスク完了時に、以下の手順で最終監査を行い、品質を保証してください。

### 3.1 最終監査 (Final Audit)
以下の手順で成果物を精査し、自信を持って「Yes」と回答できるか確認します。
1.  **整合性の再検証:** `~/.gemini/GEMINI.md` の **「2. SSOT精査と整合性検証プロトコル」** を実行し、設計ドキュメント（ADR/Design Doc）との乖離がないか確認する。
2.  **チェックリストの消込:**
    *   **[依存関係]** Issue間の `Depends-On` や前提条件に循環や矛盾がないか？
    *   **[検証可能性]** 各Issueに、完了を客観的に判断できる「検証コマンド」が含まれているか？
    *   **[ブランチ戦略]** 各フェーズのマージフロー（Foundation -> Feature -> Main）が明確に定義されているか？

### 3.2 成果物の定着
`~/.gemini/GEMINI.md` の **「プルリクエストの管理 (PR Protocol)」** に従い、提出してください。
*   **PR Body:** 移行戦略（並行稼働、Shadowing等）と、主要なマイルストーンを要約する。
