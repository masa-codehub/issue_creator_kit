# スキル: Issue 案の作成 (Issue Drafting)

**承認済みのロードマップと詳細設計書に基づき、実装エージェントが一点の疑念もなく作業を完遂可能な「タスク指示書（Draft Issue）」を構築するプロセスです。プロセスとチェックリストを統合し、品質を構造的に担保します。**

---

## State 1: Planning (準備とスコープ特定)

作業を開始する前に、何を作るべきかを明確にし、コンテキストを完全に把握します。

1.  **ロードマップの解析**:
    - `reqs/roadmap/active/` 内のアクティブなロードマップを読み込み、現在のフェーズと、未着手のタスクリスト（WBS）を特定します。
2.  **インプットの網羅的収集**:
    - 関連する **詳細設計書 (Design Doc)**、**仕様書 (Specs)**、**ADR** を特定し、全て `read_file` します。これらが Draft の記述根拠（Evidence）となります。
3.  **目標宣言と Todo 作成**:
    - 「ADR-XX Phase-Y のタスク T-1 〜 T-N の Draft を作成します」と宣言し、`save_memory` にタスクごとの進捗管理リストを作成します。

---

## State 2: Execution (ドラフト作成と精密監査)

各タスクファイルに対し、以下の 5 ステップを、チェックリストをパスしながら実行します。

### Step 1: テンプレート適用
- `reqs/tasks/template/issue-draft.md` をベースにファイルを作成します。

### Step 3: 実装手順の具体化と証拠紐付け (The Core)
詳細設計書を実装指示に変換します。
- [ ] **[コンテキスト]**: 「なぜやるのか」を ADR/Design Doc から具体的に引用しているか？
- [ ] **[入力コンテキスト]**: 実装者が `Input Context` に指定されたファイル以外を 1 つも開かずに実装を完了できるか？（不足はないか？）
- [ ] **[証拠紐付け]**: 手順の各ステップに、詳細設計書の具体的なセクション番号（例: 第 3.2 項）が明記されているか？
- [ ] **[負の制約]**: 「やってはいけないこと」が、AI の暴走（余計なリファクタリング、ライブラリ追加等）を封じ込めるレベルで具体的に書かれているか？

### Step 4: Issue パターン別・戦略と観点の定義
タスクの性質に応じて以下の3パターンから適切なものを選択し、ブランチ戦略と重点監査項目を記述します。

#### Pattern A: Foundation (Setup)
フェーズの開始タスク。開発の土台を作ります。
- **ブランチ**: Base: `main` / Head: `feature/phase-X-foundation`
- **重点観点**:
    - [ ] **基盤の確立**: 次のタスク群が依存するディレクトリや設定ファイルが正しく生成されるか？
    - [ ] **クリーンな履歴**: 開発に関係のない余計なコミットを含まない手順になっているか？

#### Pattern B: Feature (Implementation)
フェーズ途中の実装タスク。
- **ブランチ**: Base: `feature/phase-X-foundation` / Head: `feature/task-ID`
- **重点観点**:
    - [ ] **TDD の徹底**: 詳細設計に基づき、テストコードを実装コードより先に書く手順になっているか？
    - [ ] **原子性**: 1タスク1成果物の原則を守り、スコープ外の変更を含んでいないか？

#### Pattern C: Audit (Review & Promote)
フェーズ最後のタスク。マージではなく、品質保証と次フェーズへの移行判断（Gate Check）を行います。
- **ブランチ**: Base: `feature/phase-X-foundation` (作業ブランチ) / Target: `main` (PR先)
- **重点観点 (Gate Check)**:
    - [ ] **PRプロトコルの遵守**: PR作成は `~/.gemini/GEMINI.md` の「プルリクエストの管理 (PR Protocol)」に従うこと（Quality Gateの通過、Title/Bodyの形式、レビュアー指定等）。
    - [ ] **マージ禁止**: エージェント自身がマージを行ってはならない。DoDは「監査レポート付きPRの提出」である。
    - [ ] **SSOT整合性**: 実装コードと設計ドキュメント（ADR/Design Doc）に乖離がないか確認する手順が含まれているか？
    - [ ] **無駄の排除 (Lean)**: 不要なファイル、デバッグログ、コメントアウトが完全に削除されているか確認する手順が含まれているか？
    - [ ] **コンテキスト整合性**: システムコンテキスト（境界、用語）と矛盾していないか確認する手順が含まれているか？
    - [ ] **テスト網羅性**: 全てのテストシナリオがパスしているか確認する手順が含まれているか？

### Step 5: 観測可能性の確保 (Self-Correction)
- [ ] **[観測可能性]**: テスト成功/失敗時に「何が起きるか（ログメッセージ、ファイルの状態変化）」を目視確認できる手順が含まれているか？
- [ ] **[TDD Traceability]**: 検証手順に、対応する `Acceptance Criteria ID` が明記されているか？

---

## State 3: Closing (提案とプルリクエスト)

全てのタスク Draft の作成と個別監査が完了した後、これらをリポジトリに提案するための最終処理を行います。

1.  **全体整合性監査**:
    システム全体としての整合性を最後に確認します。
    - [ ] **成果物のバトンリレー**: タスク A の `Artifact` が、後続タスク B の `Input Context` に漏れなく含まれているか？
    - [ ] **依存の鎖**: 全 Issue の `depends_on` がロードマップの WBS と完全一致し、循環参照がないか？
    - [ ] **情報の重複排除**: 共通事項は設計書への参照に集約され、不要な重複説明がないか？

2.  **プルリクエストの作成 (PR Protocol 適用)**:
    作成した Draft 群を提案するために、**`~/.gemini/GEMINI.md` の「プルリクエストの管理 (PR Protocol)」を厳格に遵守して** PR を作成します。
    - **Quality Gate**: `pre-commit run --all-files` を実行し、生成した Markdown のリンターチェック等を全てパスさせる。
    - **PR作成**: `create_pull_request` を実行し、`head` (作業ブランチ) と `base` (マージ先) を明示する。
    - **記述規約**: Title を `feat(task): Draft issues for ADR-XXX Phase-Y` 形式とし、Body に関連 Issue (#71 等) と、今回作成したタスクの概要・目的・検証方法を記述する。
    - **レビュアー指定**: `update_pull_request` で `@Copilot` をレビュアーに指定する。

3.  **完了報告**:
    PR の URL を添えて、ユーザーに「Issue 案の提案（PR作成）」が完了したことを報告し、ターンの終了（メモリクリア）を行う。
