# スキル: 詳細仕様策定 (Technical Spec)

**SYSTEM_ARCHITECTが策定した抽象的な意思決定（ADR/Design Doc）を、開発者が迷いなく実装できる具体的な「実行可能な設計図」に落とし込むプロセスです。**

このドキュメントは、TECHNICAL_DESIGNER が `~/.gemini/GEMINI.md` の「プロジェクト進行フレームワーク（State Machine）」を実行する際に参照するデータソースです。

---

## 1. Planning Phase Inputs (for State 1)

計画策定時に、以下の情報を「能動的偵察 (Active Reconnaissance)」によって収集し、Todoリストの具体化に利用してください。

### 1.1 能動的偵察 (Active Reconnaissance)
*   **Issue分析:** `issue_read` で要件と依存関係を確認する。特に「完了定義（Definition of Done）」を明確にする。
*   **SSOTの精読:** `read_file` で関連するADR (`reqs/design/_approved/`) や Design Doc を読み込み、ユビキタス言語、制約、検証基準を完全に把握する。
*   **既存パターンの調査:**
    *   `glob("docs/specs/**/*.md")` で既存仕様書を特定し、構造を模倣する。
    *   `search_code` で `src/` 内の既存実装パターン（Baseクラス、共通エラーハンドリング等）を調査し、再利用可能な要素を特定する。

### 1.2 作業ブランチの計画
*   **Action:** `~/.gemini/GEMINI.md` の **「1. Gitによるバージョン管理」** に従い、作業用ブランチを作成するタスクをTodoの先頭に追加する。

### 1.3 リスク評価 (Specific Context)
`~/.gemini/GEMINI.md` の **「3. プロジェクト進行 > 3. リスク評価」** を参照し、特に以下の観点を追加で考慮する。
*   **実装可能性:** 提案する仕様は、現在の技術スタックとスケジュールで実現可能か？
*   **影響範囲:** 既存のAPIやDBスキーマへの変更が、他の機能に予期せぬ副作用を与えないか？

---

## 2. Execution Phase Actions (for State 2)

Todoを実行する際、以下の思考プロセスと記述ガードレールを遵守してください。

### 2.1 設計案の具体化 (Hypothesis - Step 1: Drafting)
インプット情報を元に、まず具体的な実装設計案を立案します。

*   **コンポーネント設計:**
    *   必要なクラス、モジュール、関数の責務と依存関係を定義する。
    *   *Check:* 既存のレイヤー構造（Controller, Service, Repository等）に従っているか？
*   **データモデル設計:**
    *   ER図、テーブル定義、JSONスキーマを設計する。
    *   *Check:* 将来の拡張性を考慮したデータ型になっているか？
*   **インタラクション設計:**
    *   Mermaid記法を用いてシーケンス図を作成し、データフローとトランザクション境界を可視化する。
    *   *Check:* 正常系だけでなく、例外系（エラーフロー）も網羅されているか？

### 2.2 整合性とインパクトの分析 (Integrity - Step 2: Validation)
`~/.gemini/GEMINI.md` の **「2. SSOT精査と整合性検証プロトコル」** を実行し、設計案の妥当性を証明します。

1.  **Fresh Read:** 関連ADRや `docs/system-context.md` を再読。
2.  **整合性チェック:** 設計案がアーキテクチャ原則（Clean Architecture等）やユビキタス言語と矛盾していないか検証する。
3.  **トレードオフ分析:** 「理想的な設計」と「現実的な実装コスト」のバランスを評価し、採用理由を明確にする。

### 2.3 自律的解決ループ (Autonomy Loop)
不明点や曖昧さがある場合、安易にユーザーに質問せず、以下のプロセスで解決します。

1.  **自己解決:** コードベースや過去のIssueを徹底的に調査し、答えを見つける。
2.  **仮説構築:** 調査でも確定できない場合、「最も合理的と思われる仮説」を立て、それを仕様として記述する。
3.  **意思決定の仰ぎ:** 重大なトレードオフやSSOTとの矛盾がある場合のみ、論点を整理してユーザーに判断を求める。
    *   *Note:* 質問は「どうすればいいですか？」ではなく「A案とB案があり、Xの理由でA案を推奨しますが、承認いただけますか？」という形式にする。

### 2.4 ドキュメント作成 (Documentation)
*   `docs/template/spec-template.md` (存在する場合) や既存の仕様書をベースに、詳細仕様書を作成または更新する。
*   **Rule:** 「多分」「おそらく」といった曖昧な表現を排除し、断定的な表現（MUST, SHOULD）を使用する。

---

## 3. Closing Phase Criteria (for State 3)

タスク完了時に、以下の手順で最終監査を行い、品質を保証してください。

### 3.1 最終監査 (Final Audit)
以下の手順で成果物を精査し、自信を持って「Yes」と回答できるか確認します。

1.  **成果物の再読:** `read_file` を用いて、完成した仕様書を読み込む。
2.  **チェックリストの消込:**
    *   **[明確性]** 曖昧な表現がなく、開発者が実装迷子にならないか？
    *   **[具体性]** 型定義、メソッドシグネチャ、エンドポイントパスが具体的か？
    *   **[網羅性]** エラーハンドリングやエッジケースが記述されているか？
    *   **[一貫性]** 用語がユビキタス言語と統一されているか？
    *   **[視覚化]** 複雑なロジックが図解（Mermaid）されているか？
    *   **[SSOT]** 上位のADR/Design Docとの整合性が保たれているか？

### 3.2 成果物の定着
`~/.gemini/GEMINI.md` の **「プルリクエストの管理 (PR Protocol)」** に従い、提出してください。
*   **PR Body:** 仕様のポイントと、考慮したトレードオフ、参照したADRへのリンクを明記する。
