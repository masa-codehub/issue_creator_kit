# スキル: アーキテクチャ可視化 (Architecture Visualization)

**システムの現状（Current State）を正確に把握し、全体像を見失わないようにするためのプロセスです。** コードベースの変更に合わせて定期的に更新し、開発者のメンタルモデルと実際のコードを一致させます。

このドキュメントは、TECHNICAL_DESIGNER が `~/.gemini/GEMINI.md` の「プロジェクト進行フレームワーク（State Machine）」を実行する際に参照するデータソースです。

---

## 1. Planning Phase Inputs (for State 1)

計画策定時に、以下の情報を「能動的偵察 (Active Reconnaissance)」によって収集し、Todoリストの具体化に利用してください。

### 1.1 能動的偵察 (Active Reconnaissance)
*   **コード構造の把握:** `list_directory("src/")` や `glob("**/*.py")` で最新のパッケージ構成を確認する。
*   **実行環境の調査:** `read_file("docker-compose.yml")`, `Dockerfile` 等で実行プロセス（コンテナ）構成を特定する。
*   **外部依存の確認:** `pyproject.toml` 等でライブラリ依存関係を確認する。
*   **既存ドキュメントの確認:** `docs/system-context.md`, `docs/architecture/c4-model.md` を読み込み、現状の記述を確認する。

### 1.2 作業ブランチの計画
*   **Action:** `~/.gemini/GEMINI.md` の **「1. Gitによるバージョン管理」** に従い、作業用ブランチを作成するタスクをTodoの先頭に追加する。

### 1.3 リスク評価 (Specific Context)
`~/.gemini/GEMINI.md` の **「3. プロジェクト進行 > 3. リスク評価」** を参照し、特に以下の観点を追加で考慮する。
*   **正確性:** 図が現実のコードと乖離していないか？（嘘の図は無いより悪い）
*   **抽象度:** 詳細すぎず、概略すぎない適切な粒度（C4モデルのLevel 2/3）か？

---

## 2. Execution Phase Actions (for State 2)

Todoを実行する際、以下の思考プロセスと記述ガードレールを遵守してください。

### 2.1 ギャップ分析 (Hypothesis - Step 1: Gap Analysis)
現状のドキュメント（To-Beと思っていたもの）と、コードの実態（As-Is）を比較します。

*   **コンテナレベル:** 新規追加されたサービスや削除されたサービスはないか？
*   **コンポーネントレベル:** パッケージ構成の変更により、コンポーネントの責務や境界が変わっていないか？
*   **関係性:** 新たな依存関係や、禁じられた依存（Architecture Violation）が発生していないか？

### 2.2 構造定義と図解 (Hypothesis - Step 2: Drafting)
ギャップを埋めるための修正案を作成します。

*   **コンポーネント定義:** 論理的なグルーピングを行い、責務を明確にする。
*   **関係性定義:** 依存の方向（Uses, Persists, etc.）を定義する。
*   **Mermaid記述:** `docs/template/c4-model-template.md` (存在する場合) に従い、Mermaid記法で図を作成する。

### 2.3 自律的解決ループ (Autonomy Loop)
不明点（例: この依存関係は意図的かバグか？）がある場合、安易にユーザーに質問せず、以下のプロセスで解決します。

1.  **自己解決:** コードの履歴（git log）や関連するPR/Issueを調査し、変更の意図を特定する。
2.  **現状優先:** 意図が不明でも、まずは「現状のコード構造」を正として図に反映させる（可視化が目的なので）。ただし、明らかにアーキテクチャ違反と思われる箇所はNoteで注釈を入れる。
3.  **報告:** 重大な違反を発見した場合は、別途Issue起票などの提案を行う。

---

## 3. Closing Phase Criteria (for State 3)

タスク完了時に、以下の手順で最終監査を行い、品質を保証してください。

### 3.1 最終監査 (Final Audit)
以下の手順で成果物を精査し、自信を持って「Yes」と回答できるか確認します。

1.  **成果物の再読:** `read_file` を用いて、更新したドキュメントを読み込む。
2.  **チェックリストの消込:**
    *   **[抽象度]** クラス図になっていないか？（C4 Componentレベルを維持）
    *   **[凡例]** 矢印の意味や向きが正しいか？
    *   **[現状一致]** コードの実態を正確に反映しているか？
    *   **[説明責任]** 図だけでなく、補足テキストで設計意図が説明されているか？
    *   **[整合性]** `docs/system-context.md` や関連ADRと矛盾していないか？

### 3.2 成果物の定着
`~/.gemini/GEMINI.md` の **「プルリクエストの管理 (PR Protocol)」** に従い、提出してください。
*   **PR Body:** 変更点（どのコンポーネントを追加/削除したか）と、その根拠となるコードの場所を明記する。
