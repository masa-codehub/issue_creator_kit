# プロンプト・アーキテクチャ設計とリファクタリング指針 (Prompt Architecture & Refactoring Guide)

エージェント定義ファイル（`GEMINI.md` および `.skills/*.md`）の保守性と拡張性を高めるための、構成管理と共通化に関する設計指針のまとめです。

## 1. 基本コンセプト: "OS" と "Application" の分離

プロンプトを「グローバルな共通ルール（OS）」と「特定の専門スキル（Application）」に明確に分離し、**関心の分離 (Separation of Concerns)** を徹底します。

| レイヤー | ファイル | 役割 (Role) | 内容の性質 (Nature) |
| :--- | :--- | :--- | :--- |
| **OS (Global)** | `~/.gemini/GEMINI.md` | **How (作法・プロセス)** | プロジェクト/組織全体で統一すべき「進行ルール」「品質基準」「共通プロトコル」。変更頻度は低い。 |
| **App (Local)** | `.gemini/AGENTS/.skills/*.md` | **What (専門技術)** | 特定の職能（ロール）に必要な「具体的な作業手順」「技術的ベストプラクティス」。変更頻度は高い。 |
| **Trigger** | エージェント定義ファイル | **Bridge (連携)** | アプリ起動時にOSの機能を明示的に呼び出すための指示記述。 |

## 2. 参照モデル (Interaction Model)

ローカルなスキルファイルから、グローバルな定義を**明示的に参照（Call）**する形式をとります。
「暗黙的に知っている」状態に依存せず、「手順として実行させる」ことで、LLMの注意（Attention）を適切に制御します。

### 理想的なワークフロー定義例

```markdown
# Skill: Feature Implementation

1. **初期化 (Init):**
   - Globalの `## 3. プロジェクト進行` を参照し、SMART目標設定とTodo作成を実行する。

2. **準備 (Setup):**
   - Globalの `## 1. Gitによるバージョン管理` に従い、作業ブランチを作成・同期する。

3. **実行 (Execute):**
   - (ここに、このスキル固有の技術的手順を記述する)
   - 例: TDDサイクル、ADR作成手順など

4. **品質保証 (QA):**
   - Globalの `## 2. 品質保証` プロトコルを実行する。
   - (必要に応じて言語固有のコマンドを指定)

5. **完了 (Finalize):**
   - Globalの `## 3. プロジェクト進行 - 振り返り` を実行し、PRを作成する。
```

## 3. 今後のリファクタリング候補 (Refactoring Candidates)

以下の要素は、現在各エージェントやスキルファイルに散在している可能性がありますが、将来的には `~/.gemini/GEMINI.md` (Global) へ集約・抽象化すべき「共通部品」です。

### A. 品質保証 (Quality Assurance)
- **現状:** BACKENDCODER等のスキル内に `ruff`, `mypy`, `pytest` の実行指示が含まれている。
- **To-Be:** `Protocol: Quality Check` として定義。「静的解析」「テスト実行」「修正ループ」のプロセス自体を標準化し、各エージェントは「コマンド」だけを注入する形にする。

### B. エラー回復と行動指針 (Error Recovery & Principles)
- **現状:** 「三振ルール（2回失敗したら仮説転換）」や「YWT/KPT」が一部のエージェントのみに紐付いている。
- **To-Be:** 知的作業を行う全エージェント共通の「デバッグ・問題解決プロトコル」としてGlobalに格上げする。

### C. ドキュメント管理 (Documentation)
- **現状:** `process_approvals` などのドキュメント承認フローや、活動報告のテンプレート利用。
- **To-Be:** 「完了の定義 (Definition of Done)」の一部として、PR作成時の必須アクションとしてGlobal化する。

## 4. 運用上の注意点

- **オーバーライドの回避:** ローカルファイルで詳細な手順を書きすぎると、グローバルの原則が無視（Attention外）されやすくなる。重要なグローバルルールは、必ずローカルの手順内で「参照」させるステップを入れること。
- **用語の統一:** 「プロジェクト進行」「品質保証」など、参照するためのセクション名は、Globalファイル内でアンカーとして機能するため、変更する際は影響範囲に注意する。
